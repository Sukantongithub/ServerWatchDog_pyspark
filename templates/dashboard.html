<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Log Anomaly Detection Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e3a8a 0%, #0f766e 100%);
        color: #333;
        padding: 20px;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-card h3 {
        color: #0f766e;
        font-size: 0.9em;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #333;
      }

      .stat-card.critical {
        border-left: 5px solid #dc2626;
      }

      .stat-card.warning {
        border-left: 5px solid #f59e0b;
      }

      .stat-card.success {
        border-left: 5px solid #10b981;
      }

      .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .chart-card h2 {
        color: #0f766e;
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      #anomalyTable {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: #0f766e;
        color: white;
        padding: 12px;
        text-align: left;
        position: sticky;
        top: 0;
      }

      td {
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .anomaly-high {
        background: #fee2e2;
        color: #991b1b;
        font-weight: bold;
      }

      .anomaly-medium {
        background: #fef3c7;
        color: #92400e;
      }

      .anomaly-low {
        background: #d1fae5;
        color: #065f46;
      }

      .alert {
        background: #dc2626;
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        animation: blink 1s infinite;
      }

      .status-online {
        background: #10b981;
      }

      @keyframes blink {
        0%,
        50%,
        100% {
          opacity: 1;
        }
        25%,
        75% {
          opacity: 0.3;
        }
      }

      #networkGraph {
        width: 100%;
        height: 500px;
        border: 1px solid #ddd;
        border-radius: 10px;
      }

      /* Enhanced Network Graph Styles */
      .graph-container {
        position: relative;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      #networkGraph {
        display: block;
        width: 100%;
        height: 600px;
        background: white;
        border-radius: 10px;
      }

      .node {
        cursor: pointer;
        stroke: white;
        stroke-width: 2px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        transition: all 0.3s ease;
      }

      .node:hover {
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
        stroke-width: 3px;
      }

      .node-service {
        fill: #0f766e;
      }

      .node-ip {
        fill: #dc2626;
      }

      .node-user {
        fill: #10b981;
      }

      .link {
        stroke: #999;
        stroke-opacity: 0.6;
        stroke-linecap: round;
        transition: all 0.3s ease;
      }

      .link:hover {
        stroke-opacity: 1;
        stroke-width: 3px;
      }

      .link-anomaly {
        stroke: #dc2626;
        stroke-opacity: 0.8;
      }

      .node-label {
        font-size: 11px;
        font-weight: bold;
        pointer-events: none;
        text-anchor: middle;
        dominant-baseline: middle;
        fill: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        max-width: 250px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border-left: 3px solid #0f766e;
        line-height: 1.5;
      }

      .tooltip.ip-tooltip {
        border-left-color: #dc2626;
      }

      .tooltip.user-tooltip {
        border-left-color: #10b981;
      }

      .tooltip-header {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 13px;
      }

      .tooltip-content {
        font-size: 11px;
      }

      .graph-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .graph-stat-item {
        background: white;
        padding: 12px 20px;
        border-radius: 8px;
        border-left: 4px solid #0f766e;
        flex: 1;
        min-width: 150px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .graph-stat-item.services {
        border-left-color: #0f766e;
      }

      .graph-stat-item.ips {
        border-left-color: #dc2626;
      }

      .graph-stat-item.users {
        border-left-color: #10b981;
      }

      .graph-stat-item.connections {
        border-left-color: #f59e0b;
      }

      .graph-stat-label {
        font-size: 0.85em;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .graph-stat-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #333;
      }

      .graph-legend {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .legend-color.service {
        background: #0f766e;
      }

      .legend-color.ip {
        background: #dc2626;
      }

      .legend-color.user {
        background: #10b981;
      }

      .graph-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .graph-btn {
        background: #0f766e;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
      }

      .graph-btn:hover {
        background: #0d5a55;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(15, 118, 110, 0.4);
      }

      .graph-btn:active {
        transform: translateY(0);
      }

      .graph-info {
        background: #f0fdfa;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #0f766e;
        color: #333;
        font-size: 0.9em;
      }

      .graph-info strong {
        color: #0f766e;
      }

      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 10px 20px;
        border-radius: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        font-size: 0.9em;
      }

      /* Separate Alert Container */
      #alertContainer {
        position: fixed;
        top: 80px;
        right: 20px;
        width: 350px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 2001;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      #alertContainer .alert {
        position: relative;
        background: #dc2626;
        color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease;
        margin-bottom: 0;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      #alertContainer .alert-close {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-size: 1.2em;
        color: white;
        background: rgba(0, 0, 0, 0.2);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }

      #alertContainer .alert-close:hover {
        background: rgba(0, 0, 0, 0.4);
      }

      #alertContainer .alert-header {
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      #alertContainer .alert-content {
        font-size: 0.9em;
        line-height: 1.4;
      }

      header {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px 0;
        margin-bottom: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      header h1 {
        margin: 0;
        color: #0f766e;
        text-shadow: none;
      }

      header p {
        color: #666;
        margin: 10px 0 0 0;
        font-size: 0.95em;
      }

      footer {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        margin-top: 50px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        color: #666;
        font-size: 0.9em;
      }

      footer p {
        margin: 5px 0;
      }

      .footer-divider {
        border-top: 1px solid #ddd;
        margin: 15px 0;
      }

      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: 1fr;
        }
        .charts-container {
          grid-template-columns: 1fr;
        }
      }

      /* Navigation Bar Styles */
      nav {
        background: linear-gradient(135deg, #1e3a8a 0%, #0f766e 100%);
        padding: 0;
        margin: -20px -20px 20px -20px;
        border-radius: 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        position: sticky;
        top: -20px;
        z-index: 1000;
      }

      .navbar-container {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        flex-wrap: wrap;
      }

      .navbar-brand {
        color: white;
        font-size: 1.5em;
        font-weight: bold;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .navbar-menu {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .nav-item {
        color: white;
        text-decoration: none;
        padding: 8px 15px;
        border-radius: 5px;
        transition: background 0.3s ease;
        font-size: 0.95em;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.3);
        font-weight: bold;
      }

      .status-badge {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
        animation: blink 1s infinite;
      }

      .status-badge.online {
        background: #10b981;
      }

      .status-badge.offline {
        background: #dc2626;
      }

      .status-badge.processing {
        background: #f59e0b;
      }

      .upload-btn,
      .process-btn,
      .system-btn,
      .spark-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.4);
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9em;
      }

      .upload-btn:hover,
      .process-btn:hover,
      .system-btn:hover,
      .spark-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.6);
      }

      .upload-btn.processing,
      .process-btn.processing {
        background: #f59e0b;
        opacity: 0.7;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        font-size: 1.5em;
        font-weight: bold;
        color: #0f766e;
        margin-bottom: 20px;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .close-btn {
        float: right;
        font-size: 2em;
        font-weight: bold;
        color: #999;
        cursor: pointer;
        line-height: 20px;
      }

      .close-btn:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }

      .form-group input[type="file"],
      .form-group input[type="text"],
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-family: inherit;
      }

      .form-group input[type="file"]:focus,
      .form-group input[type="text"]:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #0f766e;
        box-shadow: 0 0 5px #0f766e;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.95em;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #0f766e;
        color: white;
      }

      .btn-primary:hover {
        background: #0d5a55;
      }

      .btn-secondary {
        background: #999;
        color: white;
      }

      .btn-secondary:hover {
        background: #777;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-danger {
        background: #dc2626;
        color: white;
      }

      .btn-danger:hover {
        background: #b91c1c;
      }

      .system-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .system-info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
      }

      .system-info-label {
        font-weight: bold;
        color: #0f766e;
      }

      .system-info-value {
        color: #333;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #0f766e 0%, #10b981 100%);
        width: 0%;
        transition: width 0.3s ease;
      }

      .file-list {
        margin-top: 15px;
        max-height: 200px;
        overflow-y: auto;
      }

      .file-item {
        background: white;
        padding: 10px;
        margin-bottom: 5px;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .file-item button {
        background: #0f766e;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.85em;
      }

      .file-item button:hover {
        background: #0d5a55;
      }

      .fa {
        margin-right: 5px;
      }

      /* Notification Icon Styles */
      .notification-icon {
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        transition: all 0.3s ease;
      }

      .notification-icon:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .notification-badge {
        position: absolute;
        top: -5px;
        right: 0px;
        background: #dc2626;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75em;
        font-weight: bold;
        border: 2px solid #1e3a8a;
        animation: badgePulse 2s infinite;
      }

      @keyframes badgePulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(220, 38, 38, 0);
        }
      }

      /* Notification Panel */
      .notification-panel {
        position: fixed;
        top: 60px;
        right: 20px;
        width: 400px;
        max-height: 600px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 2002;
        display: none;
        flex-direction: column;
        border: 1px solid #e5e7eb;
      }

      .notification-panel.active {
        display: flex;
      }

      .notification-panel-header {
        padding: 15px 20px;
        border-bottom: 2px solid #f0f9ff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #1e3a8a 0%, #0f766e 100%);
        color: white;
        border-radius: 8px 8px 0 0;
      }

      .notification-panel-header h3 {
        margin: 0;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .notification-panel-header .clear-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.4);
        padding: 5px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
      }

      .notification-panel-header .clear-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .notification-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 0;
      }

      .notification-item {
        padding: 15px 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        gap: 12px;
        transition: background 0.2s;
        cursor: pointer;
      }

      .notification-item:hover {
        background: #f8fafc;
      }

      .notification-item:last-child {
        border-bottom: none;
      }

      .notification-item-icon {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #fee2e2;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #dc2626;
        font-size: 1.2em;
      }

      .notification-item-content {
        flex: 1;
        min-width: 0;
      }

      .notification-item-title {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.95em;
        margin-bottom: 4px;
      }

      .notification-item-message {
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 4px;
      }

      .notification-item-details {
        font-size: 0.8em;
        color: #9ca3af;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .notification-item-time {
        font-size: 0.8em;
        color: #9ca3af;
        flex-shrink: 0;
      }

      .notification-item-close {
        flex-shrink: 0;
        background: none;
        border: none;
        color: #d1d5db;
        cursor: pointer;
        font-size: 1.2em;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
      }

      .notification-item-close:hover {
        color: #6b7280;
      }

      .notification-empty {
        padding: 40px 20px;
        text-align: center;
        color: #9ca3af;
      }

      .notification-empty i {
        font-size: 2.5em;
        display: block;
        margin-bottom: 10px;
        opacity: 0.5;
      }

      @media (max-width: 768px) {
        .notification-panel {
          width: calc(100vw - 40px);
          right: 20px;
          left: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- NAVIGATION BAR -->
      <nav>
        <div class="navbar-container">
          <div class="navbar-brand">
            <i class="fas fa-search"></i> Anomaly Detection
          </div>

          <div class="navbar-menu">
            <!-- Notification Icon -->
            <div
              class="notification-icon"
              onclick="toggleNotificationPanel()"
              title="View Alerts"
            >
              <i class="fas fa-bell"></i>
              <span class="notification-badge" id="notificationBadge">0</span>
            </div>

            <!-- Upload File -->
            <button
              class="upload-btn"
              onclick="openUploadModal()"
              title="Upload Log File"
            >
              <i class="fas fa-upload"></i> Upload
            </button>

            <!-- Logs -->
            <button
              class="process-btn"
              id="logsBtn"
              onclick="openLogsModal()"
              title="View Logs"
            >
              <i class="fas fa-file-alt"></i> Logs
            </button>

            <!-- Spark UI Link -->
            <a
              class="spark-btn nav-item"
              href="http://localhost:4040"
              target="_blank"
              title="Open Spark Web UI"
            >
              <i class="fas fa-fire"></i> Spark UI
            </a>
          </div>
        </div>
      </nav>

      <!-- PAGE HEADER -->
      <header>
        <h1>
          <i class="fas fa-search"></i> Real-time Log Anomaly Detection
          Dashboard
        </h1>
        <p>
          Monitor and analyze log anomalies in real-time with advanced machine
          learning
        </p>
      </header>

      <!-- NOTIFICATION PANEL -->
      <div id="notificationPanel" class="notification-panel">
        <div class="notification-panel-header">
          <h3><i class="fas fa-bell"></i> Alerts</h3>
          <button class="clear-btn" onclick="clearAllNotifications()">
            Clear All
          </button>
        </div>
        <div class="notification-panel-content" id="notificationContent">
          <div class="notification-empty">
            <i class="fas fa-inbox"></i>
            <p>No alerts yet</p>
          </div>
        </div>
      </div>

      <!-- STATISTICS SECTION -->
      <div class="stats-grid">
        <div class="stat-card success">
          <h3><i class="fas fa-check-circle"></i> Total Logs Processed</h3>
          <div class="stat-value" id="totalLogs">0</div>
        </div>
        <div class="stat-card warning">
          <h3>
            <i class="fas fa-exclamation-triangle"></i> Anomalies Detected
          </h3>
          <div class="stat-value" id="totalAnomalies">0</div>
        </div>
        <div class="stat-card critical">
          <h3><i class="fas fa-percentage"></i> Anomaly Rate</h3>
          <div class="stat-value" id="anomalyRate">0%</div>
        </div>
        <div class="stat-card critical">
          <h3><i class="fas fa-bell"></i> Critical Alerts</h3>
          <div class="stat-value" id="criticalAlerts">0</div>
        </div>
      </div>

      <!-- CHARTS SECTION -->
      <div class="charts-container">
        <div class="chart-card">
          <h2><i class="fas fa-chart-line"></i> Anomaly Timeline</h2>
          <div id="timelineChart"></div>
        </div>
        <div class="chart-card">
          <h2><i class="fas fa-chart-bar"></i> Anomaly Score Distribution</h2>
          <div id="scoreChart"></div>
        </div>
        <div class="chart-card">
          <h2>
            <i class="fas fa-pie-chart"></i> Anomaly Distribution by Service
          </h2>
          <div id="servicePieChart"></div>
        </div>
      </div>

      <div class="chart-card" style="margin-bottom: 30px">
        <h2>
          <i class="fas fa-project-diagram"></i> Network Graph - Service
          Interactions
        </h2>

        <!-- Graph Statistics -->
        <div class="graph-stats">
          <div class="graph-stat-item services">
            <div class="graph-stat-label">
              <i class="fas fa-server"></i> Services
            </div>
            <div class="graph-stat-value" id="graphServiceCount">0</div>
          </div>
          <div class="graph-stat-item ips">
            <div class="graph-stat-label">
              <i class="fas fa-desktop"></i> IP Addresses
            </div>
            <div class="graph-stat-value" id="graphIpCount">0</div>
          </div>
          <div class="graph-stat-item users">
            <div class="graph-stat-label">
              <i class="fas fa-users"></i> Users
            </div>
            <div class="graph-stat-value" id="graphUserCount">0</div>
          </div>
          <div class="graph-stat-item connections">
            <div class="graph-stat-label">
              <i class="fas fa-link"></i> Connections
            </div>
            <div class="graph-stat-value" id="graphConnectionCount">0</div>
          </div>
        </div>

        <!-- Graph Legend -->
        <div class="graph-legend">
          <div class="legend-item">
            <div class="legend-color service"></div>
            <span>Services</span>
          </div>
          <div class="legend-item">
            <div class="legend-color ip"></div>
            <span>IP Addresses</span>
          </div>
          <div class="legend-item">
            <div class="legend-color user"></div>
            <span>Users</span>
          </div>
        </div>

        <!-- Graph Controls -->
        <div class="graph-controls">
          <button class="graph-btn" onclick="resetGraphZoom()">
            <i class="fas fa-redo"></i> Reset View
          </button>
          <button class="graph-btn" onclick="pauseGraphSimulation()">
            <i class="fas fa-pause"></i> Pause
          </button>
          <button class="graph-btn" onclick="resumeGraphSimulation()">
            <i class="fas fa-play"></i> Resume
          </button>
          <button class="graph-btn" onclick="zoomGraphIn()">
            <i class="fas fa-search-plus"></i> Zoom In
          </button>
          <button class="graph-btn" onclick="zoomGraphOut()">
            <i class="fas fa-search-minus"></i> Zoom Out
          </button>
        </div>

        <!-- Graph Info -->
        <div class="graph-info">
          <i class="fas fa-lightbulb"></i> <strong>Tip:</strong> Drag nodes to
          reposition them. Hover over nodes and links for details. Thicker lines
          indicate higher interaction frequency.
        </div>

        <!-- SVG Container -->
        <div id="networkGraph" style="position: relative"></div>
      </div>

      <!-- ANOMALIES TABLE SECTION -->
      <div id="anomalyTable">
        <h2 style="color: #0f766e; margin-bottom: 15px">
          <i class="fas fa-exclamation-circle"></i> Recent Anomalies
        </h2>
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Service</th>
              <th>Level</th>
              <th>Message</th>
              <th>IP Address</th>
              <th>Anomaly Score</th>
            </tr>
          </thead>
          <tbody id="anomalyTableBody">
            <tr>
              <td colspan="6" style="text-align: center; color: #999">
                Waiting for anomalies...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- PAGE FOOTER -->
      <footer>
        <div class="footer-divider"></div>
        <p><strong>Log Anomaly Detection System v1.0</strong></p>
        <p>Powered by Apache Spark MLlib | Real-time Monitoring & Analysis</p>
        <p>¬© 2025 - Anomaly Detection Platform | All Rights Reserved</p>
        <p style="margin-top: 10px; font-size: 0.85em; color: #999">
          Last Updated: <span id="lastUpdate">Loading...</span>
        </p>
      </footer>
    </div>

    <!-- UPLOAD MODAL -->
    <div id="uploadModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeUploadModal()">&times;</span>
        <div class="modal-header">
          <i class="fas fa-upload"></i> Upload Log File
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="logFile">Select Log File (.log or .txt)</label>
            <input type="file" id="logFile" accept=".log,.txt" />
          </div>
          <div
            id="uploadStatus"
            style="
              display: none;
              margin-top: 10px;
              padding: 10px;
              border-radius: 5px;
            "
          ></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeUploadModal()">
            Cancel
          </button>
          <button class="btn btn-primary" id="uploadBtn" onclick="uploadFile()">
            Upload
          </button>
        </div>
      </div>
    </div>

    <!-- PROCESS MODAL -->
    <div id="processModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeProcessModal()">&times;</span>
        <div class="modal-header">
          <i class="fas fa-cog"></i> Process Log File
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="logFilePath">Log File Path</label>
            <input
              type="text"
              id="logFilePath"
              placeholder="logs/server_logs.log"
              value="logs/server_logs.log"
            />
          </div>
          <div
            id="processStatus"
            style="
              display: none;
              margin-top: 10px;
              padding: 10px;
              border-radius: 5px;
            "
          ></div>
          <div id="uploadedFiles" class="file-list"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeProcessModal()">
            Cancel
          </button>
          <button
            class="btn btn-primary"
            id="processBtn2"
            onclick="processLog()"
          >
            Process
          </button>
        </div>
      </div>
    </div>

    <!-- LOGS MODAL -->
    <div id="logsModal" class="modal">
      <div class="modal-content" style="max-width: 900px; margin: 5% auto">
        <span class="close-btn" onclick="closeLogsModal()">&times;</span>
        <div class="modal-header">
          <i class="fas fa-file-alt"></i> Generated Logs
        </div>
        <div class="modal-body" style="max-height: 600px; overflow-y: auto">
          <div id="logsContent" style="display: none">
            <table style="width: 100%; border-collapse: collapse">
              <thead>
                <tr
                  style="
                    background: #0f766e;
                    color: white;
                    position: sticky;
                    top: 0;
                  "
                >
                  <th
                    style="
                      padding: 12px;
                      text-align: left;
                      border: 1px solid #ddd;
                    "
                  >
                    Filename
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: left;
                      border: 1px solid #ddd;
                    "
                  >
                    Size
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: left;
                      border: 1px solid #ddd;
                    "
                  >
                    Created
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: center;
                      border: 1px solid #ddd;
                    "
                  >
                    Action
                  </th>
                </tr>
              </thead>
              <tbody id="logsTableBody"></tbody>
            </table>
          </div>
          <div
            id="logsEmpty"
            style="text-align: center; padding: 40px; color: #999"
          >
            <i
              class="fas fa-inbox"
              style="
                font-size: 2.5em;
                margin-bottom: 10px;
                display: block;
                opacity: 0.5;
              "
            ></i>
            <p>No logs found</p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeLogsModal()">
            Close
          </button>
          <button
            class="btn btn-primary"
            onclick="refreshLogs()"
            style="display: flex; align-items: center; gap: 8px"
          >
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- SYSTEM INFO MODAL -->
    <div id="systemInfoModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeSystemInfoModal()">&times;</span>
        <div class="modal-header">
          <i class="fas fa-info-circle"></i> System Information
        </div>
        <div class="modal-body">
          <div class="system-info">
            <div class="system-info-item">
              <span class="system-info-label">Status:</span>
              <span class="system-info-value" id="infoStatus">Offline</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Uptime:</span>
              <span class="system-info-value" id="infoUptime">0 seconds</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Spark Status:</span>
              <span class="system-info-value" id="infoSparkStatus"
                >Offline</span
              >
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Logs Processed Today:</span>
              <span class="system-info-value" id="infoLogsProcessed">0</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Total Logs:</span>
              <span class="system-info-value" id="infoTotalLogs">0</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Total Anomalies:</span>
              <span class="system-info-value" id="infoTotalAnomalies">0</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Anomaly Rate:</span>
              <span class="system-info-value" id="infoAnomalyRate">0%</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Processing:</span>
              <span class="system-info-value" id="infoProcessing">No</span>
            </div>
          </div>
          <div style="margin-top: 15px">
            <p style="margin-bottom: 10px; font-weight: bold">Last Anomaly:</p>
            <div
              id="infoLastAnomaly"
              style="
                background: white;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 0.9em;
              "
            >
              No anomalies yet
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeSystemInfoModal()">
            Close
          </button>
          <button class="btn btn-primary" onclick="refreshSystemInfo()">
            Refresh
          </button>
        </div>
      </div>
    </div>
    <script>
      // Initialize Socket.IO connection
      const socket = io();

      // Data storage
      let anomalyScores = [];
      let timelineData = { timestamps: [], counts: [] };

      // Update last updated timestamp
      function updateLastUpdated() {
        const now = new Date();
        document.getElementById("lastUpdate").textContent =
          now.toLocaleString();
      }

      // Socket event handlers
      socket.on("connect", () => {
        console.log("Connected to server");
        updateLastUpdated();
      });

      socket.on("disconnect", () => {
        console.log("Disconnected from server");
      });

      socket.on("new_anomaly", (data) => {
        addAnomalyToTable(data);
        anomalyScores.push(data.anomaly_score || 0);
        updateScoreChart();
        updateLastUpdated();

        if (data.anomaly_score > 0.8) {
          showAlert(data);
        }
      });

      socket.on("stats_update", (data) => {
        updateStatistics(data);
        updateLastUpdated();
      });

      // Update statistics
      function updateStatistics(data) {
        document.getElementById("totalLogs").textContent =
          data.total_logs.toLocaleString();
        document.getElementById("totalAnomalies").textContent =
          data.total_anomalies.toLocaleString();
        document.getElementById("anomalyRate").textContent =
          (data.anomaly_rate * 100).toFixed(2) + "%";
      }

      // Add anomaly to table
      function addAnomalyToTable(anomaly) {
        const tbody = document.getElementById("anomalyTableBody");

        // Remove placeholder if exists
        if (
          tbody.children.length === 1 &&
          tbody.children[0].children.length === 1
        ) {
          tbody.innerHTML = "";
        }

        const row = tbody.insertRow(0);
        const score = anomaly.anomaly_score || 0;
        const scoreClass =
          score > 0.8
            ? "anomaly-high"
            : score > 0.5
            ? "anomaly-medium"
            : "anomaly-low";

        row.innerHTML = `
                <td>${anomaly.timestamp || "N/A"}</td>
                <td>${anomaly.service || "N/A"}</td>
                <td>${anomaly.level || "N/A"}</td>
                <td>${anomaly.message || "N/A"}</td>
                <td>${anomaly.ip_address || "N/A"}</td>
                <td class="${scoreClass}">${score.toFixed(3)}</td>
            `;

        // Keep only last 50 rows
        while (tbody.rows.length > 50) {
          tbody.deleteRow(tbody.rows.length - 1);
        }
      }

      // Show critical alert
      function showAlert(anomaly) {
        // Alerts now only display in notification panel
        if (anomaly.anomaly_score > 0.8) {
          addNotification(anomaly);
        }
      }

      // Update score distribution chart
      function updateScoreChart() {
        const trace = {
          x: anomalyScores,
          type: "histogram",
          marker: {
            color: "#0f766e",
          },
          nbinsx: 20,
        };

        const layout = {
          title: "",
          xaxis: { title: "Anomaly Score" },
          yaxis: { title: "Count" },
          margin: { t: 20, r: 20, b: 40, l: 50 },
        };

        Plotly.newPlot("scoreChart", [trace], layout, { responsive: true });
      }

      // Update timeline chart
      function updateTimelineChart() {
        fetch("/api/timeline_data")
          .then((response) => response.json())
          .then((data) => {
            const trace = {
              x: data.timestamps,
              y: data.counts,
              type: "scatter",
              mode: "lines+markers",
              marker: { color: "#dc2626" },
              line: { color: "#dc2626", width: 2 },
            };

            const layout = {
              title: "",
              xaxis: { title: "Time" },
              yaxis: { title: "Anomalies" },
              margin: { t: 20, r: 20, b: 80, l: 50 },
            };

            Plotly.newPlot("timelineChart", [trace], layout, {
              responsive: true,
            });
          });
      }

      // Load network graph
      let networkGraphSimulation = null;
      let networkGraphPaused = false;
      let networkGraphZoom = null;

      function loadNetworkGraph() {
        fetch("/api/graph_data")
          .then((response) => response.json())
          .then((data) => {
            console.log("üìä Graph data received:", data);

            if (!data || !data.nodes || data.nodes.length === 0) {
              console.warn("‚ö†Ô∏è No graph data available");
              document.getElementById("networkGraph").innerHTML =
                '<p style="text-align: center; padding: 50px; color: #999;">üìä Loading graph visualization...</p>';
              return;
            }

            console.log(
              `‚úÖ Rendering graph with ${data.nodes.length} nodes and ${data.links.length} links`
            );
            renderEnhancedNetworkGraph(data);
            updateGraphStatistics(data);
          })
          .catch((error) => {
            console.error("‚ùå Error loading graph:", error);
            document.getElementById("networkGraph").innerHTML =
              '<p style="text-align: center; padding: 50px; color: red;">Error loading graph. Check console for details.</p>';
          });
      }

      function renderEnhancedNetworkGraph(data) {
        try {
          const container = document.getElementById("networkGraph");
          const width = container.clientWidth || 800;
          const height = 600;

          console.log(`üé® Creating SVG: ${width}x${height}`);

          // Clear previous content
          container.innerHTML = "";

          // Create a set of valid node IDs for faster lookup
          const validNodeIds = new Set(data.nodes.map((n) => n.id));
          console.log(`üìã Valid node IDs: ${validNodeIds.size}`);

          // Filter links to only include those with valid source and target nodes
          const validLinks = data.links.filter((link) => {
            const sourceId = link.source.id || link.source;
            const targetId = link.target.id || link.target;
            const isValid =
              validNodeIds.has(sourceId) && validNodeIds.has(targetId);
            if (!isValid) {
              console.warn(
                `‚ö†Ô∏è Skipping invalid link: ${sourceId} -> ${targetId}`
              );
            }
            return isValid;
          });

          console.log(
            `‚úÖ Filtered links: ${validLinks.length} / ${data.links.length} valid`
          );

          if (validLinks.length === 0) {
            console.warn("‚ö†Ô∏è No valid links after filtering");
          }

          // Create SVG
          const svg = d3
            .select("#networkGraph")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("background", "black")
            .style("border-radius", "10px");

          console.log("‚úÖ SVG created");

          // Add gradient definitions
          const defs = svg.append("defs");

          defs
            .append("linearGradient")
            .attr("id", "linkGradient")
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "100%")
            .append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#0f766e");

          // Add shadow filter
          const filter = defs
            .append("filter")
            .attr("id", "shadow")
            .attr("x", "-50%")
            .attr("y", "-50%")
            .attr("width", "200%")
            .attr("height", "200%");

          filter
            .append("feDropShadow")
            .attr("dx", 0)
            .attr("dy", 2)
            .attr("stdDeviation", 3)
            .attr("flood-opacity", 0.3);

          console.log("‚úÖ Filters and gradients added");

          // Create zoom behavior
          networkGraphZoom = d3.zoom().on("zoom", (event) => {
            g.attr("transform", event.transform);
          });

          svg.call(networkGraphZoom);

          // Create main group
          const g = svg.append("g");

          console.log("üîß Creating force simulation...");

          // Create force simulation with validated links
          networkGraphSimulation = d3
            .forceSimulation(data.nodes)
            .force(
              "link",
              d3
                .forceLink(validLinks)
                .id((d) => d.id)
                .distance((d) => 100 / (d.value || 1))
                .strength(0.5)
            )
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(25));

          console.log("‚úÖ Force simulation created");

          // Create links
          console.log(`üìç Creating ${validLinks.length} links...`);
          const links = g
            .append("g")
            .selectAll("line")
            .data(validLinks)
            .enter()
            .append("line")
            .attr("class", "link")
            .attr("stroke-width", (d) => Math.sqrt(d.value) * 1.5)
            .on("mouseover", function (event, d) {
              showLinkTooltip(event, d);
              d3.select(this)
                .attr("stroke-opacity", 1)
                .attr("stroke-width", (link) => Math.sqrt(link.value) * 3);
            })
            .on("mouseout", function () {
              hideLinkTooltip();
              d3.select(this)
                .attr("stroke-opacity", 0.6)
                .attr("stroke-width", (link) => Math.sqrt(link.value) * 1.5);
            });

          console.log("‚úÖ Links created");

          // Create nodes
          console.log(`üî¥ Creating ${data.nodes.length} nodes...`);
          const nodes = g
            .append("g")
            .selectAll("circle")
            .data(data.nodes)
            .enter()
            .append("circle")
            .attr("class", (d) => `node node-${d.type}`)
            .attr("r", (d) => {
              const connectionCount = validLinks.filter(
                (l) =>
                  (l.source.id || l.source) === d.id ||
                  (l.target.id || l.target) === d.id
              ).length;
              return 8 + connectionCount * 2;
            })
            .attr("filter", "url(#shadow)")
            .call(
              d3
                .drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended)
            )
            .on("mouseover", function (event, d) {
              showNodeTooltip(event, d);
              d3.select(this)
                .transition()
                .duration(200)
                .attr("r", (node) => {
                  const connectionCount = validLinks.filter(
                    (l) =>
                      (l.source.id || l.source) === node.id ||
                      (l.target.id || l.target) === node.id
                  ).length;
                  return 12 + connectionCount * 2;
                });
              links.style("stroke-opacity", (link) => {
                return (link.source.id || link.source) === d.id ||
                  (link.target.id || link.target) === d.id
                  ? 1
                  : 0.2;
              });
            })
            .on("mouseout", function (event, d) {
              hideNodeTooltip();
              d3.select(this)
                .transition()
                .duration(200)
                .attr("r", (node) => {
                  const connectionCount = validLinks.filter(
                    (l) =>
                      (l.source.id || l.source) === node.id ||
                      (l.target.id || l.target) === node.id
                  ).length;
                  return 8 + connectionCount * 2;
                });
              links.style("stroke-opacity", 0.6);
            });

          console.log("‚úÖ Nodes created");

          // Add labels
          console.log("üìù Adding labels...");
          const labels = g
            .append("g")
            .selectAll("text")
            .data(data.nodes)
            .enter()
            .append("text")
            .attr("class", "node-label")
            .attr("text-anchor", "middle")
            .attr("dy", ".3em")
            .text((d) =>
              d.id.length > 12 ? d.id.substring(0, 10) + ".." : d.id
            )
            .style("font-size", (d) => {
              const connectionCount = validLinks.filter(
                (l) =>
                  (l.source.id || l.source) === d.id ||
                  (l.target.id || l.target) === d.id
              ).length;
              return 10 + connectionCount * 0.5 + "px";
            });

          console.log("‚úÖ Labels added");

          // Update positions on each tick
          let tickCount = 0;
          networkGraphSimulation.on("tick", () => {
            tickCount++;
            if (tickCount % 50 === 0) {
              console.log(`‚è±Ô∏è Simulation tick ${tickCount}`);
            }

            links
              .attr("x1", (d) => d.source.x)
              .attr("y1", (d) => d.source.y)
              .attr("x2", (d) => d.target.x)
              .attr("y2", (d) => d.target.y);

            nodes.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
            labels.attr("x", (d) => d.x).attr("y", (d) => d.y);
          });

          console.log("üéâ Graph rendering complete!");

          // Drag functions
          function dragstarted(event, d) {
            if (!event.active)
              networkGraphSimulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          }

          function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
          }

          function dragended(event, d) {
            if (!event.active) networkGraphSimulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          }
        } catch (error) {
          console.error("‚ùå Error rendering graph:", error);
          document.getElementById("networkGraph").innerHTML =
            '<p style="text-align: center; padding: 50px; color: red;">Error rendering graph. Check console.</p>';
        }
      }

      function updateGraphStatistics(data) {
        const serviceCount = data.nodes.filter(
          (n) => n.type === "service"
        ).length;
        const ipCount = data.nodes.filter((n) => n.type === "ip").length;
        const userCount = data.nodes.filter((n) => n.type === "user").length;

        document.getElementById("graphServiceCount").textContent = serviceCount;
        document.getElementById("graphIpCount").textContent = ipCount;
        document.getElementById("graphUserCount").textContent = userCount;
        document.getElementById("graphConnectionCount").textContent =
          data.links.length;
      }

      function showNodeTooltip(event, node) {
        const connectionCount = document.querySelectorAll(".node").length; // Approximate
        const tooltip = document.createElement("div");
        tooltip.id = "nodeTooltip";
        tooltip.className = `tooltip ${node.type}-tooltip`;
        tooltip.innerHTML = `
          <div class="tooltip-header">${node.id}</div>
          <div class="tooltip-content">
            <strong>Type:</strong> ${node.type.toUpperCase()}<br>
            <strong>Label:</strong> ${node.label || node.id}<br>
            <strong>Node ID:</strong> ${node.id}
          </div>
        `;
        tooltip.style.left = event.pageX + 10 + "px";
        tooltip.style.top = event.pageY + 10 + "px";
        document.body.appendChild(tooltip);
      }

      function hideNodeTooltip() {
        const tooltip = document.getElementById("nodeTooltip");
        if (tooltip) tooltip.remove();
      }

      function showLinkTooltip(event, link) {
        const source = link.source.id || link.source;
        const target = link.target.id || link.target;
        const tooltip = document.createElement("div");
        tooltip.id = "linkTooltip";
        tooltip.className = "tooltip";
        tooltip.innerHTML = `
          <div class="tooltip-header">Connection</div>
          <div class="tooltip-content">
            <strong>From:</strong> ${source}<br>
            <strong>To:</strong> ${target}<br>
            <strong>Strength:</strong> ${link.value}
          </div>
        `;
        tooltip.style.left = event.pageX + 10 + "px";
        tooltip.style.top = event.pageY + 10 + "px";
        document.body.appendChild(tooltip);
      }

      function hideLinkTooltip() {
        const tooltip = document.getElementById("linkTooltip");
        if (tooltip) tooltip.remove();
      }

      function resetGraphZoom() {
        if (networkGraphZoom) {
          d3.select("#networkGraph svg")
            .transition()
            .duration(750)
            .call(
              networkGraphZoom.transform,
              d3.zoomIdentity.translate(0, 0).scale(1)
            );
        }
      }

      function pauseGraphSimulation() {
        if (networkGraphSimulation) {
          networkGraphPaused = true;
          networkGraphSimulation.stop();
        }
      }

      function resumeGraphSimulation() {
        if (networkGraphSimulation) {
          networkGraphPaused = false;
          networkGraphSimulation.restart();
        }
      }

      function zoomGraphIn() {
        if (networkGraphZoom) {
          d3.select("#networkGraph svg")
            .transition()
            .duration(300)
            .call(networkGraphZoom.scaleBy, 1.3);
        }
      }

      function zoomGraphOut() {
        if (networkGraphZoom) {
          d3.select("#networkGraph svg")
            .transition()
            .duration(300)
            .call(networkGraphZoom.scaleBy, 0.7);
        }
      }

      // Fetch anomaly distribution data
      function updateServicePieChart() {
        fetch("/api/anomaly_distribution")
          .then((response) => response.json())
          .then((data) => {
            if (!data.services || data.services.length === 0) {
              console.warn("No service data available for pie chart");
              return;
            }

            const trace = {
              labels: data.services,
              values: data.counts,
              type: "pie",
            };

            const layout = {
              title: "",
              height: 400,
            };

            Plotly.newPlot("servicePieChart", [trace], layout, {
              responsive: true,
            });
          })
          .catch((error) => console.error("Error loading pie chart:", error));
      }

      // Fetch initial data
      function fetchInitialData() {
        fetch("/api/stats")
          .then((response) => response.json())
          .then((data) => {
            updateStatistics(data);
            document.getElementById("criticalAlerts").textContent =
              data.critical_alerts;
          });

        fetch("/api/recent_anomalies")
          .then((response) => response.json())
          .then((anomalies) => {
            if (Array.isArray(anomalies)) {
              anomalies.forEach((anomaly) => {
                addAnomalyToTable(anomaly);
                anomalyScores.push(anomaly.anomaly_score || 0);
              });
              updateScoreChart();
            }
          });

        updateTimelineChart();
        loadNetworkGraph();
        updateServicePieChart();
        updateLastUpdated();
      }

      // Initialize dashboard
      fetchInitialData();

      // Refresh data periodically
      setInterval(fetchInitialData, 10000);
      setInterval(updateTimelineChart, 5000);
      setInterval(updateServicePieChart, 10000);
      setInterval(updateLastUpdated, 60000); // Update footer timestamp every minute

      // ==========================================
      // MODAL FUNCTIONS
      // ==========================================

      // Upload Modal Functions
      function openUploadModal() {
        document.getElementById("uploadModal").style.display = "block";
      }

      function closeUploadModal() {
        document.getElementById("uploadModal").style.display = "none";
        document.getElementById("uploadStatus").style.display = "none";
      }

      function uploadFile() {
        const fileInput = document.getElementById("logFile");
        const file = fileInput.files[0];

        if (!file) {
          showUploadStatus("Please select a file", "error");
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        const uploadBtn = document.getElementById("uploadBtn");
        uploadBtn.disabled = true;
        uploadBtn.textContent = "Uploading...";

        fetch("/api/upload", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              showUploadStatus(
                "‚úÖ File uploaded successfully: " + data.filepath,
                "success"
              );
              fileInput.value = "";
            } else {
              showUploadStatus("‚ùå Upload failed: " + data.error, "error");
            }
          })
          .catch((error) => {
            showUploadStatus("‚ùå Error: " + error, "error");
          })
          .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.textContent = "Upload";
          });
      }

      function showUploadStatus(message, type) {
        const statusDiv = document.getElementById("uploadStatus");
        statusDiv.textContent = message;
        statusDiv.style.display = "block";
        statusDiv.style.background = type === "success" ? "#d4edda" : "#f8d7da";
        statusDiv.style.color = type === "success" ? "#155724" : "#721c24";
        statusDiv.style.border =
          type === "success" ? "1px solid #c3e6cb" : "1px solid #f5c6cb";
      }

      // Process Modal Functions
      function openProcessModal() {
        document.getElementById("processModal").style.display = "block";
      }

      function closeProcessModal() {
        document.getElementById("processModal").style.display = "none";
        document.getElementById("processStatus").style.display = "none";
      }

      function processLog() {
        const filePath = document.getElementById("logFilePath").value;

        if (!filePath) {
          showProcessStatus("Please enter a file path", "error");
          return;
        }

        const processBtn = document.getElementById("processBtn2");
        processBtn.disabled = true;
        processBtn.textContent = "Processing...";

        fetch("/api/process_log", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ filepath: filePath }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              showProcessStatus(
                "‚úÖ Processing completed: " + data.message,
                "success"
              );
            } else {
              showProcessStatus("‚ùå Processing failed: " + data.error, "error");
            }
          })
          .catch((error) => {
            showProcessStatus("‚ùå Error: " + error, "error");
          })
          .finally(() => {
            processBtn.disabled = false;
            processBtn.textContent = "Process";
          });
      }

      function showProcessStatus(message, type) {
        const statusDiv = document.getElementById("processStatus");
        statusDiv.textContent = message;
        statusDiv.style.display = "block";
        statusDiv.style.background = type === "success" ? "#d4edda" : "#f8d7da";
        statusDiv.style.color = type === "success" ? "#155724" : "#721c24";
        statusDiv.style.border =
          type === "success" ? "1px solid #c3e6cb" : "1px solid #f5c6cb";
      }

      // Logs Modal Functions
      function openLogsModal() {
        document.getElementById("logsModal").style.display = "block";
        refreshLogs();
      }

      function closeLogsModal() {
        document.getElementById("logsModal").style.display = "none";
      }

      function refreshLogs() {
        fetch("/api/logs")
          .then((response) => response.json())
          .then((logs) => {
            const logsContent = document.getElementById("logsContent");
            const logsEmpty = document.getElementById("logsEmpty");
            const logsTableBody = document.getElementById("logsTableBody");

            if (logs.length === 0) {
              logsContent.style.display = "none";
              logsEmpty.style.display = "block";
              return;
            }

            logsContent.style.display = "block";
            logsEmpty.style.display = "none";

            logsTableBody.innerHTML = logs
              .map(
                (log) => `
                <tr>
                  <td style="padding: 10px; border: 1px solid #ddd;">${log.filename}</td>
                  <td style="padding: 10px; border: 1px solid #ddd;">${log.size}</td>
                  <td style="padding: 10px; border: 1px solid #ddd;">${log.created}</td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <a href="${log.download_url}" target="_blank" style="margin-right: 10px; color: #0f766e; text-decoration: none;">
                      <i class="fas fa-download"></i> Download
                    </a>
                    <a href="${log.view_url}" target="_blank" style="color: #0f766e; text-decoration: none;">
                      <i class="fas fa-eye"></i> View
                    </a>
                  </td>
                </tr>
              `
              )
              .join("");
          })
          .catch((error) => {
            console.error("Error fetching logs:", error);
          });
      }

      // System Info Modal Functions
      function openSystemInfoModal() {
        document.getElementById("systemInfoModal").style.display = "block";
        refreshSystemInfo();
      }

      function closeSystemInfoModal() {
        document.getElementById("systemInfoModal").style.display = "none";
      }

      function refreshSystemInfo() {
        fetch("/api/system/status")
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("infoStatus").textContent = data.is_running
              ? "üü¢ Running"
              : "üî¥ Stopped";
            document.getElementById("infoUptime").textContent = formatUptime(
              data.uptime
            );
            document.getElementById("infoSparkStatus").textContent =
              data.spark_status;
            document.getElementById("infoLogsProcessed").textContent =
              data.logs_processed_today.toLocaleString();
            document.getElementById("infoTotalLogs").textContent =
              data.total_logs.toLocaleString();
            document.getElementById("infoTotalAnomalies").textContent =
              data.total_anomalies.toLocaleString();
            document.getElementById("infoAnomalyRate").textContent =
              (data.anomaly_rate * 100).toFixed(2) + "%";
            document.getElementById("infoProcessing").textContent =
              data.current_processing ? "üîÑ Yes" : "‚úì No";

            if (data.last_anomaly) {
              document.getElementById("infoLastAnomaly").innerHTML = `
                <strong>${data.last_anomaly.service}</strong><br>
                Score: ${data.last_anomaly.anomaly_score.toFixed(3)}<br>
                Time: ${data.last_anomaly.timestamp}<br>
                IP: ${data.last_anomaly.ip_address}
              `;
            }
          })
          .catch((error) => {
            console.error("Error fetching system info:", error);
          });
      }

      function formatUptime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hours}h ${minutes}m ${secs}s`;
      }

      // System Control Functions
      function toggleSystem() {
        const btn = document.getElementById("systemToggleBtn");
        const isRunning = btn.textContent.includes("Stop");

        const endpoint = isRunning ? "/api/system/stop" : "/api/system/start";

        fetch(endpoint, { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            updateSystemStatus();
          })
          .catch((error) => {
            console.error("Error toggling system:", error);
          });
      }

      function updateSystemStatus() {
        fetch("/api/system_status")
          .then((response) => response.json())
          .then((status) => {
            // Status elements were removed from navbar
            // This function now just logs the status
            console.log("System status updated:", status);
          })
          .catch((error) => {
            console.error("Error updating system status:", error);
          });
      }

      // Socket event for system status updates
      socket.on("system_status_update", (status) => {
        updateSystemStatus();
      });

      // Update system status on page load
      updateSystemStatus();

      // Auto-refresh system status every 5 seconds
      setInterval(updateSystemStatus, 5000);

      // Close modals when clicking outside
      window.onclick = function (event) {
        const uploadModal = document.getElementById("uploadModal");
        const processModal = document.getElementById("processModal");
        const logsModal = document.getElementById("logsModal");
        const systemInfoModal = document.getElementById("systemInfoModal");

        if (event.target == uploadModal) {
          uploadModal.style.display = "none";
        }
        if (event.target == processModal) {
          processModal.style.display = "none";
        }
        if (event.target == logsModal) {
          logsModal.style.display = "none";
        }
        if (event.target == systemInfoModal) {
          systemInfoModal.style.display = "none";
        }
      };

      // Notification management
      let notifications = [];
      const MAX_NOTIFICATIONS = 50;

      // Toggle notification panel
      function toggleNotificationPanel() {
        const panel = document.getElementById("notificationPanel");
        panel.classList.toggle("active");
      }

      // Close notification panel when clicking outside
      document.addEventListener("click", (event) => {
        const notificationPanel = document.getElementById("notificationPanel");
        const notificationIcon = document.querySelector(".notification-icon");

        if (
          !notificationPanel.contains(event.target) &&
          !notificationIcon.contains(event.target)
        ) {
          notificationPanel.classList.remove("active");
        }
      });

      // Add notification to the panel
      function addNotification(anomaly) {
        const notification = {
          id: Date.now(),
          timestamp: new Date(),
          service: anomaly.service || "Unknown",
          score: anomaly.anomaly_score || 0,
          ip: anomaly.ip_address || "N/A",
          message: anomaly.message || "Anomaly detected",
        };

        notifications.unshift(notification);

        // Keep only max notifications
        if (notifications.length > MAX_NOTIFICATIONS) {
          notifications.pop();
        }

        updateNotificationBadge();
        renderNotifications();
      }

      // Update notification badge count
      function updateNotificationBadge() {
        const badge = document.getElementById("notificationBadge");
        const count = notifications.length;
        badge.textContent = count > 99 ? "99+" : count;
        badge.style.display = count > 0 ? "flex" : "none";
      }

      // Render notifications in the panel
      function renderNotifications() {
        const content = document.getElementById("notificationContent");

        if (notifications.length === 0) {
          content.innerHTML = `
            <div class="notification-empty">
              <i class="fas fa-inbox"></i>
              <p>No alerts yet</p>
            </div>
          `;
          return;
        }

        content.innerHTML = notifications
          .map(
            (notif) => `
            <div class="notification-item">
              <div class="notification-item-icon">
                <i class="fas fa-exclamation-circle"></i>
              </div>
              <div class="notification-item-content">
                <div class="notification-item-title">
                  Critical Anomaly - ${notif.service}
                </div>
                <div class="notification-item-message">
                  ${notif.message}
                </div>
                <div class="notification-item-details">
                  <span><strong>Score:</strong> ${notif.score.toFixed(3)}</span>
                  <span><strong>IP:</strong> ${notif.ip}</span>
                </div>
              </div>
              <div class="notification-item-time">
                ${formatNotificationTime(notif.timestamp)}
              </div>
              <button class="notification-item-close" onclick="removeNotification(${
                notif.id
              })">
                √ó
              </button>
            </div>
          `
          )
          .join("");
      }

      // Format notification time
      function formatNotificationTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return "Just now";
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        return `${days}d ago`;
      }

      // Remove individual notification
      function removeNotification(id) {
        notifications = notifications.filter((n) => n.id !== id);
        updateNotificationBadge();
        renderNotifications();
      }

      // Clear all notifications
      function clearAllNotifications() {
        notifications = [];
        updateNotificationBadge();
        renderNotifications();
      }

      // Update showAlert to also add to notifications
      const originalShowAlert = showAlert;
      showAlert = function (anomaly) {
        originalShowAlert(anomaly);
        addNotification(anomaly);
      };

      // Initialize notification badge
      updateNotificationBadge();
    </script>
  </body>
</html>
