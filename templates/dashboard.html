<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Log Anomaly Detection Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        color: #333;
        overflow-x: hidden;
      }

      /* Top Header - Only Title and Alerts */
      .top-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 70px;
        background: linear-gradient(135deg, #1e3a8a 0%, #0f766e 100%);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
      }

      .header-title {
        color: white;
        font-size: 1.8em;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .header-title i {
        font-size: 1.2em;
      }

      /* Notification Icon in Header */
      .notification-icon {
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .notification-icon:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .notification-icon i {
        font-size: 1.5em;
      }

      .notification-badge {
        position: absolute;
        top: 2px;
        right: 5px;
        background: #dc2626;
        color: white;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7em;
        font-weight: bold;
        border: 2px solid #1e3a8a;
        animation: badgePulse 2s infinite;
      }

      @keyframes badgePulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(220, 38, 38, 0);
        }
      }

      /* Aside Navbar - Dark Theme */
      .aside-navbar {
        position: fixed;
        top: 70px;
        left: 0;
        width: 260px;
        height: calc(100vh - 70px);
        background: linear-gradient(180deg, #1a1f2e 0%, #0f1419 100%);
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
        padding: 25px 0;
        z-index: 999;
        overflow-y: auto;
        overflow-x: hidden;
      }

      /* Custom Scrollbar for Dark Navbar */
      .aside-navbar::-webkit-scrollbar {
        width: 6px;
      }

      .aside-navbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
      }

      .aside-navbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
      }

      .aside-navbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .nav-section {
        padding: 0 12px;
        margin-bottom: 15px;
      }

      .nav-section-title {
        font-size: 0.7em;
        text-transform: uppercase;
        color: #6b7280;
        font-weight: 700;
        padding: 12px 15px 8px 15px;
        letter-spacing: 1px;
        margin-top: 5px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 16px;
        margin: 6px 0;
        color: #9ca3af;
        text-decoration: none;
        border-radius: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        font-size: 0.95em;
        font-weight: 500;
        position: relative;
        overflow: hidden;
      }

      .nav-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: linear-gradient(135deg, #0f766e 0%, #10b981 100%);
        transform: scaleY(0);
        transition: transform 0.3s ease;
      }

      .nav-item i {
        font-size: 1.3em;
        width: 24px;
        text-align: center;
        transition: all 0.3s ease;
      }

      .nav-item:hover {
        background: rgba(15, 118, 110, 0.15);
        color: #10b981;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
      }

      .nav-item:hover::before {
        transform: scaleY(1);
      }

      .nav-item:hover i {
        transform: scale(1.15);
        color: #10b981;
      }

      .nav-item.active {
        background: linear-gradient(
          135deg,
          rgba(15, 118, 110, 0.25) 0%,
          rgba(16, 185, 129, 0.2) 100%
        );
        color: #10b981;
        font-weight: 600;
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.25);
        border-left: 3px solid #10b981;
        padding-left: 13px;
      }

      .nav-item.active i {
        color: #10b981;
        transform: scale(1.1);
      }

      .nav-item.active::before {
        transform: scaleY(1);
      }

      /* Badge/Indicator for active items */
      .nav-item.active::after {
        content: "";
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
        animation: pulse-dot 2s infinite;
      }

      @keyframes pulse-dot {
        0%,
        100% {
          opacity: 1;
          transform: translateY(-50%) scale(1);
        }
        50% {
          opacity: 0.7;
          transform: translateY(-50%) scale(1.2);
        }
      }

      .nav-divider {
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.1) 50%,
          transparent 100%
        );
        margin: 20px 15px;
      }

      /* Special styling for external links */
      .nav-item[target="_blank"]::after {
        content: "\f35d";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: absolute;
        right: 12px;
        font-size: 0.75em;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .nav-item[target="_blank"]:hover::after {
        opacity: 0.6;
      }

      /* Main Content Area */
      .main-content {
        margin-left: 260px;
        margin-top: 70px;
        padding: 30px;
        min-height: calc(100vh - 70px);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .aside-navbar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }

        .aside-navbar.mobile-open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .header-title {
          font-size: 1.3em;
        }
      }

      /* Keep existing styles for other components */
      h1 {
        text-align: center;
        color: #0f766e;
        margin-bottom: 30px;
        font-size: 2em;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      }

      .stat-card h3 {
        color: #0f766e;
        font-size: 0.9em;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #333;
      }

      .stat-card.critical {
        border-left: 5px solid #dc2626;
      }

      .stat-card.warning {
        border-left: 5px solid #f59e0b;
      }

      .stat-card.success {
        border-left: 5px solid #10b981;
      }

      .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      .chart-card h2 {
        color: #0f766e;
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      #anomalyTable {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: #0f766e;
        color: white;
        padding: 12px;
        text-align: left;
        position: sticky;
        top: 0;
      }

      td {
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .anomaly-high {
        background: #fee2e2;
        color: #991b1b;
        font-weight: bold;
      }

      .anomaly-medium {
        background: #fef3c7;
        color: #92400e;
      }

      .anomaly-low {
        background: #d1fae5;
        color: #065f46;
      }

      .alert {
        background: #dc2626;
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        animation: blink 1s infinite;
      }

      .status-online {
        background: #10b981;
      }

      @keyframes blink {
        0%,
        50%,
        100% {
          opacity: 1;
        }
        25%,
        75% {
          opacity: 0.3;
        }
      }

      #networkGraph {
        width: 100%;
        height: 500px;
        border: 1px solid #ddd;
        border-radius: 10px;
      }

      /* Enhanced Network Graph Styles */
      .graph-container {
        position: relative;
        background: #000000;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      #networkGraph {
        display: block;
        width: 100%;
        height: 600px;
        background: #000000;
        border-radius: 10px;
      }

      .node {
        cursor: pointer;
        stroke: white;
        stroke-width: 2px;
        filter: drop-shadow(0 2px 4px rgba(255, 255, 255, 0.3));
        transition: all 0.3s ease;
      }

      .node:hover {
        filter: drop-shadow(0 4px 8px rgba(255, 255, 255, 0.6));
        stroke-width: 3px;
      }

      .node-service {
        fill: #0f766e;
      }

      .node-ip {
        fill: #dc2626;
      }

      .node-user {
        fill: #10b981;
      }

      .link {
        stroke: #666;
        stroke-opacity: 0.6;
        stroke-linecap: round;
        transition: all 0.3s ease;
      }

      .link:hover {
        stroke-opacity: 1;
        stroke-width: 3px;
        stroke: #0f766e;
      }

      .link-anomaly {
        stroke: #dc2626;
        stroke-opacity: 0.8;
      }

      .node-label {
        font-size: 11px;
        font-weight: bold;
        pointer-events: none;
        text-anchor: middle;
        dominant-baseline: middle;
        fill: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
      }

      .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        max-width: 250px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border-left: 3px solid #0f766e;
        line-height: 1.5;
      }

      .tooltip.ip-tooltip {
        border-left-color: #dc2626;
      }

      .tooltip.user-tooltip {
        border-left-color: #10b981;
      }

      .tooltip-header {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 13px;
      }

      .tooltip-content {
        font-size: 11px;
      }

      .graph-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .graph-stat-item {
        background: white;
        padding: 12px 20px;
        border-radius: 8px;
        border-left: 4px solid #0f766e;
        flex: 1;
        min-width: 150px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .graph-stat-item.services {
        border-left-color: #0f766e;
      }

      .graph-stat-item.ips {
        border-left-color: #dc2626;
      }

      .graph-stat-item.users {
        border-left-color: #10b981;
      }

      .graph-stat-item.connections {
        border-left-color: #f59e0b;
      }

      .graph-stat-label {
        font-size: 0.85em;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .graph-stat-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #333;
      }

      .graph-legend {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .legend-color.service {
        background: #0f766e;
      }

      .legend-color.ip {
        background: #dc2626;
      }

      .legend-color.user {
        background: #10b981;
      }

      .graph-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .graph-btn {
        background: #0f766e;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
      }

      .graph-btn:hover {
        background: #0d5a55;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(15, 118, 110, 0.4);
      }

      .graph-btn:active {
        transform: translateY(0);
      }

      .graph-info {
        background: #f0fdfa;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #0f766e;
        color: #333;
        font-size: 0.9em;
      }

      .graph-info strong {
        color: #0f766e;
      }

      /* Separate Alert Container */
      #alertContainer {
        position: fixed;
        top: 80px;
        right: 20px;
        width: 350px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 2001;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      #alertContainer .alert {
        position: relative;
        background: #dc2626;
        color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease;
        margin-bottom: 0;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      #alertContainer .alert-close {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-size: 1.2em;
        color: white;
        background: rgba(0, 0, 0, 0.2);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }

      #alertContainer .alert-close:hover {
        background: rgba(0, 0, 0, 0.4);
      }

      #alertContainer .alert-header {
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      #alertContainer .alert-content {
        font-size: 0.9em;
        line-height: 1.4;
      }

      header {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px 0;
        margin-bottom: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      header h1 {
        margin: 0;
        color: #0f766e;
        text-shadow: none;
      }

      header p {
        color: #666;
        margin: 10px 0 0 0;
        font-size: 0.95em;
      }

      footer {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        margin-top: 50px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        color: #666;
        font-size: 0.9em;
      }

      footer p {
        margin: 5px 0;
      }

      .footer-divider {
        border-top: 1px solid #ddd;
        margin: 15px 0;
      }

      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: 1fr;
        }
        .charts-container {
          grid-template-columns: 1fr;
        }
      }

      /* Navigation Bar Styles */
      nav {
        background: linear-gradient(135deg, #1e3a8a 0%, #0f766e 100%);
        padding: 0;
        margin: -20px -20px 20px -20px;
        border-radius: 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        position: sticky;
        top: -20px;
        z-index: 1000;
      }

      .navbar-container {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        flex-wrap: wrap;
      }

      .navbar-brand {
        color: white;
        font-size: 1.5em;
        font-weight: bold;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .navbar-menu {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .nav-item {
        color: white;
        text-decoration: none;
        padding: 8px 15px;
        border-radius: 5px;
        transition: background 0.3s ease;
        font-size: 0.95em;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.3);
        font-weight: bold;
      }

      .status-badge {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
        animation: blink 1s infinite;
      }

      .status-badge.online {
        background: #10b981;
      }

      .status-badge.offline {
        background: #dc2626;
      }

      .status-badge.processing {
        background: #f59e0b;
      }

      .upload-btn,
      .process-btn,
      .system-btn,
      .spark-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.4);
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9em;
      }

      .upload-btn:hover,
      .process-btn:hover,
      .system-btn:hover,
      .spark-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.6);
      }

      .upload-btn.processing,
      .process-btn.processing {
        background: #f59e0b;
        opacity: 0.7;
      }

      /* Navigation Tabs */
      .nav-tab {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-tab:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .nav-tab.active {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.6);
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* Main Content Sections */
      .main-section {
        display: none;
      }

      .main-section.active {
        display: block;
      }

      /* Main Tab Content */
      .main-tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
      }

      .main-tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        font-size: 1.5em;
        font-weight: bold;
        color: #0f766e;
        margin-bottom: 20px;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .close-btn {
        float: right;
        font-size: 2em;
        font-weight: bold;
        color: #999;
        cursor: pointer;
        line-height: 20px;
      }

      .close-btn:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }

      .form-group input[type="file"],
      .form-group input[type="text"],
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-family: inherit;
      }

      .form-group input[type="file"]:focus,
      .form-group input[type="text"]:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #0f766e;
        box-shadow: 0 0 5px #0f766e;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.95em;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #0f766e;
        color: white;
      }

      .btn-primary:hover {
        background: #0d5a55;
      }

      .btn-secondary {
        background: #999;
        color: white;
      }

      .btn-secondary:hover {
        background: #777;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-danger {
        background: #dc2626;
        color: white;
      }

      .btn-danger:hover {
        background: #b91c1c;
      }

      .system-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .system-info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
      }

      .system-info-label {
        font-weight: bold;
        color: #0f766e;
      }

      .system-info-value {
        color: #333;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #0f766e 0%, #10b981 100%);
        width: 0%;
        transition: width 0.3s ease;
      }

      .file-list {
        margin-top: 15px;
        max-height: 200px;
        overflow-y: auto;
      }

      .file-item {
        background: white;
        padding: 10px;
        margin-bottom: 5px;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .file-item button {
        background: #0f766e;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.85em;
      }

      .file-item button:hover {
        background: #0d5a55;
      }

      .fa {
        margin-right: 5px;
      }

      /* Notification Icon Styles */
      .notification-icon {
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
        border-radius: 5px;
        transition: all 0.3s ease;
      }

      .notification-icon:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .notification-badge {
        position: absolute;
        top: -5px;
        right: 0px;
        background: #dc2626;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75em;
        font-weight: bold;
        border: 2px solid #1e3a8a;
        animation: badgePulse 2s infinite;
      }

      @keyframes badgePulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(220, 38, 38, 0);
        }
      }

      /* Notification Panel */
      .notification-panel {
        position: fixed;
        top: 60px;
        right: 20px;
        width: 400px;
        max-height: 600px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 2002;
        display: none;
        flex-direction: column;
        border: 1px solid #e5e7eb;
      }

      .notification-panel.active {
        display: flex;
      }

      .notification-panel-header {
        padding: 15px 20px;
        border-bottom: 2px solid #f0f9ff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #1e3a8a 0%, #0f766e 100%);
        color: white;
        border-radius: 8px 8px 0 0;
      }

      .notification-panel-header h3 {
        margin: 0;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .notification-panel-header .clear-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.4);
        padding: 5px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
      }

      .notification-panel-header .clear-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .notification-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 0;
      }

      .notification-item {
        padding: 15px 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        gap: 12px;
        transition: background 0.2s;
        cursor: pointer;
      }

      .notification-item:hover {
        background: #f8fafc;
      }

      .notification-item:last-child {
        border-bottom: none;
      }

      .notification-item-icon {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #fee2e2;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #dc2626;
        font-size: 1.2em;
      }

      .notification-item-content {
        flex: 1;
        min-width: 0;
      }

      .notification-item-title {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.95em;
        margin-bottom: 4px;
      }

      .notification-item-message {
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 4px;
      }

      .notification-item-details {
        font-size: 0.8em;
        color: #9ca3af;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .notification-item-time {
        font-size: 0.8em;
        color: #9ca3af;
        flex-shrink: 0;
      }

      .notification-item-close {
        flex-shrink: 0;
        background: none;
        border: none;
        color: #d1d5db;
        cursor: pointer;
        font-size: 1.2em;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
      }

      .notification-item-close:hover {
        color: #6b7280;
      }

      .notification-empty {
        padding: 40px 20px;
        text-align: center;
        color: #9ca3af;
      }

      .notification-empty i {
        font-size: 2.5em;
        display: block;
        margin-bottom: 10px;
        opacity: 0.5;
      }

      @media (max-width: 768px) {
        .notification-panel {
          width: calc(100vw - 40px);
          right: 20px;
          left: 20px;
        }
      }

      /* Enhanced Dataset Analysis Buttons */
      #datasetTab .btn {
        padding: 12px 18px;
        border-radius: 8px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }
      #datasetTab .btn-primary {
        background: linear-gradient(135deg, #0f766e 0%, #10b981 100%);
        border: 1px solid #0f766e;
      }
      #datasetTab .btn-primary:hover {
        filter: brightness(0.95);
        transform: translateY(-1px);
      }
      #datasetTab .btn-secondary {
        background: #eef2f7;
        color: #0f766e;
        border: 1px solid #d1d5db;
      }
      #datasetTab .btn-secondary:hover {
        background: #e5eaf1;
        transform: translateY(-1px);
      }
      /* Improve analysis options layout */
      #datasetTab .form-group label {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      #datasetTab input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #0f766e;
      }
      #datasetTab input[type="range"] {
        accent-color: #0f766e;
      }
    </style>
  </head>
  <body>
    <div class="top-header">
      <div class="header-title">
        <i class="fas fa-search"></i> Anomaly Detection
      </div>
      <div
        class="notification-icon"
        onclick="toggleNotificationPanel()"
        title="View Alerts"
      >
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationBadge">0</span>
      </div>
    </div>

    <div class="aside-navbar">
      <div class="nav-section">
        <div class="nav-section-title">Navigation</div>
        <a
          class="nav-item active"
          onclick="switchMainTab('dashboard'); return false;"
          data-tab="dashboard"
          href="#"
        >
          <i class="fas fa-chart-line"></i> Realtime Dashboard
        </a>
        <a
          class="nav-item"
          onclick="switchMainTab('dataset'); return false;"
          data-tab="dataset"
          href="#"
        >
          <i class="fas fa-database"></i> Dataset Analysis
        </a>
        <a
          class="nav-item"
          onclick="switchMainTab('network'); return false;"
          data-tab="network"
          href="#"
          title="Network Analysis"
        >
          <i class="fas fa-project-diagram"></i> Network Analysis
        </a>
        <a
          class="nav-item"
          onclick="openLogsModal(); return false;"
          data-tab="logs"
          href="#"
          title="View Logs"
        >
          <i class="fas fa-file-alt"></i> Logs
        </a>
        <a
          class="nav-item"
          href="http://localhost:4040"
          target="_blank"
          title="Open Spark Web UI"
        >
          <i class="fas fa-fire"></i> Spark UI
        </a>
      </div>
    </div>

    <div class="main-content">
      <!-- PAGE HEADER -->
      <!-- <header>
        <h1>
          <i class="fas fa-search"></i> Real-time Log Anomaly Detection
          Dashboard
        </h1>
        <p>
          Monitor and analyze log anomalies in real-time with advanced machine
          learning
        </p>
      </header> -->

      <!-- NOTIFICATION PANEL -->
      <div id="notificationPanel" class="notification-panel">
        <div class="notification-panel-header">
          <h3><i class="fas fa-bell"></i> Alerts</h3>
          <button class="clear-btn" onclick="clearAllNotifications()">
            Clear All
          </button>
        </div>
        <div class="notification-panel-content" id="notificationContent">
          <div class="notification-empty">
            <i class="fas fa-inbox"></i>
            <p>No alerts yet</p>
          </div>
        </div>
      </div>

      <!-- MAIN CONTENT SECTIONS -->

      <!-- DASHBOARD TAB CONTENT -->
      <div id="dashboardTab" class="main-tab-content active">
        <!-- STATISTICS SECTION -->
        <div class="stats-grid">
          <div class="stat-card success">
            <h3><i class="fas fa-check-circle"></i> Total Logs Processed</h3>
            <div class="stat-value" id="totalLogs">0</div>
          </div>
          <div class="stat-card warning">
            <h3>
              <i class="fas fa-exclamation-triangle"></i> Anomalies Detected
            </h3>
            <div class="stat-value" id="totalAnomalies">0</div>
          </div>
          <div class="stat-card critical">
            <h3><i class="fas fa-percentage"></i> Anomaly Rate</h3>
            <div class="stat-value" id="anomalyRate">0%</div>
          </div>
          <div class="stat-card critical">
            <h3><i class="fas fa-bell"></i> Critical Alerts</h3>
            <div class="stat-value" id="criticalAlerts">0</div>
          </div>
        </div>

        <!-- CHARTS SECTION -->
        <div class="charts-container">
          <div class="chart-card">
            <h2><i class="fas fa-chart-line"></i> Anomaly Timeline</h2>
            <div id="timelineChart"></div>
          </div>
          <div class="chart-card">
            <h2><i class="fas fa-chart-bar"></i> Anomaly Score Distribution</h2>
            <div id="scoreChart"></div>
          </div>
          <div class="chart-card">
            <h2>
              <i class="fas fa-pie-chart"></i> Anomaly Distribution by Service
            </h2>
            <div id="servicePieChart"></div>
          </div>
        </div>

        <!-- ANOMALIES TABLE SECTION -->
        <div id="anomalyTable">
          <h2 style="color: #0f766e; margin-bottom: 15px">
            <i class="fas fa-exclamation-circle"></i> Recent Anomalies
          </h2>
          <table>
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Service</th>
                <th>Level</th>
                <th>Message</th>
                <th>IP Address</th>
                <th>Anomaly Score</th>
              </tr>
            </thead>
            <tbody id="anomalyTableBody">
              <tr>
                <td colspan="6" style="text-align: center; color: #999">
                  Waiting for anomalies...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- NETWORK ANALYSIS TAB CONTENT -->
      <div id="networkTab" class="main-tab-content">
        <header style="margin-top: 0">
          <h1 style="margin: 0">
            <i class="fas fa-project-diagram"></i> Network Analysis
          </h1>
          <p>
            Explore service interactions, IP correlations, and user activity
            through an interactive force-directed graph. Drag nodes to
            reposition, zoom and pan to focus areas, and hover for detailed
            tooltips.
          </p>
        </header>
        <div class="chart-card" style="margin-bottom: 30px">
          <h2>
            <i class="fas fa-network-wired"></i> Service Interaction Graph
          </h2>
          <div class="graph-info">
            <strong>Overview:</strong> This graph visualizes relationships
            between services, IPs, and users derived from recent logs. Link
            thickness indicates interaction strength.
            <br />
            <strong>How to use:</strong> Use the controls to reset view,
            pause/resume simulation, and zoom. Hover nodes/links for metadata.
          </div>
          <div class="graph-stats">
            <div class="graph-stat-item services">
              <div class="graph-stat-label">
                <i class="fas fa-server"></i> Services
              </div>
              <div class="graph-stat-value" id="graphServiceCount">0</div>
            </div>
            <div class="graph-stat-item ips">
              <div class="graph-stat-label">
                <i class="fas fa-desktop"></i> IP Addresses
              </div>
              <div class="graph-stat-value" id="graphIpCount">0</div>
            </div>
            <div class="graph-stat-item users">
              <div class="graph-stat-label">
                <i class="fas fa-users"></i> Users
              </div>
              <div class="graph-stat-value" id="graphUserCount">0</div>
            </div>
            <div class="graph-stat-item connections">
              <div class="graph-stat-label">
                <i class="fas fa-link"></i> Connections
              </div>
              <div class="graph-stat-value" id="graphConnectionCount">0</div>
            </div>
          </div>
          <div class="graph-legend">
            <div class="legend-item">
              <div class="legend-color service"></div>
              <span>Services</span>
            </div>
            <div class="legend-item">
              <div class="legend-color ip"></div>
              <span>IP Addresses</span>
            </div>
            <div class="legend-item">
              <div class="legend-color user"></div>
              <span>Users</span>
            </div>
          </div>
          <div class="graph-controls">
            <button class="graph-btn" onclick="resetGraphZoom()">
              <i class="fas fa-redo"></i> Reset View
            </button>
            <button class="graph-btn" onclick="pauseGraphSimulation()">
              <i class="fas fa-pause"></i> Pause
            </button>
            <button class="graph-btn" onclick="resumeGraphSimulation()">
              <i class="fas fa-play"></i> Resume
            </button>
            <button class="graph-btn" onclick="zoomGraphIn()">
              <i class="fas fa-search-plus"></i> Zoom In
            </button>
            <button class="graph-btn" onclick="zoomGraphOut()">
              <i class="fas fa-search-minus"></i> Zoom Out
            </button>
          </div>
          <div id="networkGraph" style="position: relative"></div>
        </div>
      </div>

      <!-- DATASET ANALYSIS TAB CONTENT -->
      <div id="datasetTab" class="main-tab-content">
        <header style="margin-top: 0">
          <h1 style="margin: 0">
            <i class="fas fa-database"></i> Dataset Analysis & Anomaly Detection
          </h1>
          <p>
            Upload and analyze log datasets with advanced machine learning
            algorithms
          </p>
        </header>

        <!-- Analysis Tab Content Container -->
        <div
          style="
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
          "
        >
          <!-- Upload & Analyze Tab -->
          <div id="uploadTab" class="analysis-tab-content active">
            <div class="form-group">
              <label for="datasetFile">
                <i class="fas fa-file-upload"></i> Select Dataset File (.log or
                .txt)
              </label>
              <input
                type="file"
                id="datasetFile"
                accept=".log,.txt"
                style="margin-bottom: 10px"
              />
              <div style="font-size: 0.9em; color: #666; margin-bottom: 15px">
                <i class="fas fa-info-circle"></i> Supports log files up to
                16MB. Analysis uses both pattern matching and Spark MLlib for
                comprehensive anomaly detection.
              </div>
            </div>

            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
              "
            >
              <div>
                <h4 style="color: #0f766e; margin-bottom: 10px">
                  <i class="fas fa-cogs"></i> Analysis Options
                </h4>
                <div class="form-group">
                  <label>
                    <input
                      type="checkbox"
                      id="useSparkMLlib"
                      checked
                      style="margin-right: 8px"
                    />
                    Use Spark MLlib Analysis (Recommended)
                  </label>
                  <div
                    style="font-size: 0.85em; color: #666; margin-left: 20px"
                  >
                    Advanced machine learning with clustering and feature
                    engineering
                  </div>
                </div>
                <div class="form-group">
                  <label>
                    <input
                      type="checkbox"
                      id="generateAlerts"
                      checked
                      style="margin-right: 8px"
                    />
                    Generate Severity-based Alerts
                  </label>
                </div>
                <div class="form-group">
                  <label>
                    <input
                      type="checkbox"
                      id="analyzeNetworkGraph"
                      checked
                      style="margin-right: 8px"
                    />
                    Generate Network Analysis
                  </label>
                </div>
              </div>
              <div>
                <h4 style="color: #0f766e; margin-bottom: 10px">
                  <i class="fas fa-sliders-h"></i> Detection Sensitivity
                </h4>
                <div class="form-group">
                  <label for="anomalyThreshold"
                    >Anomaly Detection Threshold</label
                  >
                  <input
                    type="range"
                    id="anomalyThreshold"
                    min="0.1"
                    max="0.9"
                    step="0.1"
                    value="0.4"
                    style="width: 100%; margin-bottom: 5px"
                  />
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 0.85em;
                      color: #666;
                    "
                  >
                    <span>More Sensitive</span>
                    <span id="thresholdValue">0.4</span>
                    <span>Less Sensitive</span>
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px">
              <button
                class="btn btn-primary"
                id="analyzeDatasetBtn"
                onclick="startDatasetAnalysis()"
              >
                <i class="fas fa-play"></i> Start Analysis
              </button>
              <button class="btn btn-secondary" onclick="loadRecentAnalyses()">
                <i class="fas fa-history"></i> View Recent Analyses
              </button>
            </div>

            <!-- Analysis Progress -->
            <div
              id="analysisProgress"
              style="display: none; margin-bottom: 20px"
            >
              <div
                style="
                  background: #f0f9ff;
                  padding: 15px;
                  border-radius: 8px;
                  border-left: 4px solid #0f766e;
                "
              >
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 10px;
                  "
                >
                  <div class="analysis-spinner"></div>
                  <strong id="analysisStatus">Initializing analysis...</strong>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="analysisProgressBar"></div>
                </div>
                <div
                  style="font-size: 0.85em; color: #666; margin-top: 5px"
                  id="analysisDetails"
                >
                  Preparing dataset for analysis...
                </div>
              </div>
            </div>

            <!-- Recent Analyses List -->
            <div id="recentAnalyses" style="margin-top: 20px">
              <h4 style="color: #0f766e; margin-bottom: 15px">
                <i class="fas fa-history"></i> Recent Analyses
              </h4>
              <div
                id="recentAnalysesList"
                style="max-height: 400px; overflow-y: auto"
              ></div>
            </div>
          </div>

          <!-- Analysis Results Tab -->
          <div id="resultsTab" class="analysis-tab-content">
            <div id="analysisResultsContent">
              <div style="text-align: center; padding: 40px; color: #999">
                <i
                  class="fas fa-chart-line"
                  style="font-size: 2.5em; margin-bottom: 15px; opacity: 0.5"
                ></i>
                <p>Select an analysis from the Upload tab to view results</p>
              </div>
            </div>
          </div>

          <!-- Log Viewer Tab -->
          <div id="viewerTab" class="analysis-tab-content">
            <div id="logViewerContent">
              <div style="text-align: center; padding: 40px; color: #999">
                <i
                  class="fas fa-eye"
                  style="font-size: 2.5em; margin-bottom: 15px; opacity: 0.5"
                ></i>
                <p>Select an analysis to view logs with anomaly highlighting</p>
              </div>
            </div>
          </div>

          <!-- Alerts Tab -->
          <div id="alertsTab" class="analysis-tab-content">
            <div id="alertsContent">
              <div style="text-align: center; padding: 40px; color: #999">
                <i
                  class="fas fa-bell"
                  style="font-size: 2.5em; margin-bottom: 15px; opacity: 0.5"
                ></i>
                <p>Select an analysis to view generated alerts</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PAGE FOOTER -->
      <footer>
        <div class="footer-divider"></div>
        <p><strong>Log Anomaly Detection System v1.0</strong></p>
        <p>Powered by Apache Spark MLlib | Real-time Monitoring & Analysis</p>
        <p>Â© 2025 - Anomaly Detection Platform | All Rights Reserved</p>
        <p style="margin-top: 10px; font-size: 0.85em; color: #999">
          Last Updated: <span id="lastUpdate">Loading...</span>
        </p>
      </footer>
    </div>

    <!-- UPLOAD MODAL -->
    <div id="uploadModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeUploadModal()">&times;</span>
        <div class="modal-header">
          <i class="fas fa-upload"></i> Upload Log File
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="logFile">Select Log File (.log or .txt)</label>
            <input type="file" id="logFile" accept=".log,.txt" />
          </div>
          <div
            id="uploadStatus"
            style="
              display: none;
              margin-top: 10px;
              padding: 10px;
              border-radius: 5px;
            "
          ></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeUploadModal()">
            Cancel
          </button>
          <button class="btn btn-primary" id="uploadBtn" onclick="uploadFile()">
            Upload
          </button>
        </div>
      </div>
    </div>

    <!-- PROCESS MODAL -->
    <div id="processModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeProcessModal()">&times;</span>
        <div class="modal-header">
          <i class="fas fa-cog"></i> Process Log File
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="logFilePath">Log File Path</label>
            <input
              type="text"
              id="logFilePath"
              placeholder="logs/server_logs.log"
              value="logs/server_logs.log"
            />
          </div>
          <div
            id="processStatus"
            style="
              display: none;
              margin-top: 10px;
              padding: 10px;
              border-radius: 5px;
            "
          ></div>
          <div id="uploadedFiles" class="file-list"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeProcessModal()">
            Cancel
          </button>
          <button
            class="btn btn-primary"
            id="processBtn2"
            onclick="processLog()"
          >
            Process
          </button>
        </div>
      </div>
    </div>

    <!-- LOGS MODAL -->
    <div id="logsModal" class="modal">
      <div class="modal-content" style="max-width: 900px; margin: 5% auto">
        <span class="close-btn" onclick="closeLogsModal()">&times;</span>
        <div class="modal-header">
          <i class="fas fa-file-alt"></i> Generated Logs
        </div>
        <div class="modal-body" style="max-height: 600px; overflow-y: auto">
          <div id="logsContent" style="display: none">
            <table style="width: 100%; border-collapse: collapse">
              <thead>
                <tr
                  style="
                    background: #0f766e;
                    color: white;
                    position: sticky;
                    top: 0;
                  "
                >
                  <th
                    style="
                      padding: 12px;
                      text-align: left;
                      border: 1px solid #ddd;
                    "
                  >
                    Filename
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: left;
                      border: 1px solid #ddd;
                    "
                  >
                    Size
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: left;
                      border: 1px solid #ddd;
                    "
                  >
                    Created
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: center;
                      border: 1px solid #ddd;
                    "
                  >
                    Action
                  </th>
                </tr>
              </thead>
              <tbody id="logsTableBody"></tbody>
            </table>
          </div>
          <div
            id="logsEmpty"
            style="text-align: center; padding: 40px; color: #999"
          >
            <i
              class="fas fa-inbox"
              style="
                font-size: 2.5em;
                margin-bottom: 10px;
                display: block;
                opacity: 0.5;
              "
            ></i>
            <p>No logs found</p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeLogsModal()">
            Close
          </button>
          <button
            class="btn btn-primary"
            onclick="refreshLogs()"
            style="display: flex; align-items: center; gap: 8px"
          >
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- SYSTEM INFO MODAL -->
    <div id="systemInfoModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeSystemInfoModal()">&times;</span>
        <div class="modal-header">
          <i class="fas fa-info-circle"></i> System Information
        </div>
        <div class="modal-body">
          <div class="system-info">
            <div class="system-info-item">
              <span class="system-info-label">Status:</span>
              <span class="system-info-value" id="infoStatus">Offline</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Uptime:</span>
              <span class="system-info-value" id="infoUptime">0 seconds</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Spark Status:</span>
              <span class="system-info-value" id="infoSparkStatus"
                >Offline</span
              >
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Logs Processed Today:</span>
              <span class="system-info-value" id="infoLogsProcessed">0</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Total Logs:</span>
              <span class="system-info-value" id="infoTotalLogs">0</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Total Anomalies:</span>
              <span class="system-info-value" id="infoTotalAnomalies">0</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Anomaly Rate:</span>
              <span class="system-info-value" id="infoAnomalyRate">0%</span>
            </div>
            <div class="system-info-item">
              <span class="system-info-label">Processing:</span>
              <span class="system-info-value" id="infoProcessing">No</span>
            </div>
          </div>
          <div style="margin-top: 15px">
            <p style="margin-bottom: 10px; font-weight: bold">Last Anomaly:</p>
            <div
              id="infoLastAnomaly"
              style="
                background: white;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 0.9em;
              "
            >
              No anomalies yet
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeSystemInfoModal()">
            Close
          </button>
          <button class="btn btn-primary" onclick="refreshSystemInfo()">
            Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- Add complete JavaScript section -->
    <script>
      // Initialize Socket.IO connection
      const socket = io();

      // Data storage
      let anomalyScores = [];
      let timelineData = { timestamps: [], counts: [] };

      // Network Graph Variables
      let networkGraphSimulation = null;
      let networkGraphSvg = null;
      let networkGraphZoom = null;
      let networkGraphData = null;

      // ==========================================
      // UTILITY FUNCTIONS
      // ==========================================

      function updateLastUpdated() {
        const now = new Date();
        document.getElementById("lastUpdate").textContent =
          now.toLocaleString();
      }

      // ==========================================
      // SOCKET.IO EVENT HANDLERS
      // ==========================================

      socket.on("connect", () => {
        console.log("â Connected to server");
        updateLastUpdated();
      });

      socket.on("disconnect", () => {
        console.log("â Disconnected from server");
      });

      socket.on("new_anomaly", (data) => {
        console.log("ð¨ New anomaly received:", data);
        addAnomalyToTable(data);
        anomalyScores.push(data.anomaly_score || 0);
        updateScoreChart();
        updateLastUpdated();

        if (data.anomaly_score > 0.8) {
          addNotification(data);
        }
      });

      socket.on("stats_update", (data) => {
        console.log("ð Stats updated:", data);
        updateStatistics(data);
        updateLastUpdated();
      });

      // ==========================================
      // DATASET ANALYSIS SOCKET.IO LISTENERS
      // ==========================================

      socket.on("dataset_analysis_started", (data) => {
        console.log("ð Dataset analysis started:", data);
        document.getElementById("analysisProgress").style.display = "block";
        document.getElementById("analysisProgressBar").style.width = "5%";
        document.getElementById("analysisStatus").textContent =
          "Analysis started with Spark MLlib...";
        document.getElementById(
          "analysisDetails"
        ).textContent = `Processing: ${data.filename}`;
      });

      socket.on("dataset_analysis_progress", (data) => {
        console.log("ð Analysis progress:", data);
        document.getElementById("analysisProgressBar").style.width =
          data.progress + "%";
        document.getElementById("analysisStatus").textContent = data.status;
        document.getElementById("analysisDetails").textContent = data.details;
      });

      socket.on("dataset_analysis_completed", (data) => {
        console.log("â Dataset analysis completed:", data);
        document.getElementById("analysisProgressBar").style.width = "100%";
        document.getElementById("analysisStatus").textContent =
          "Analysis Complete!";
        document.getElementById("analysisDetails").innerHTML = `
          <strong>Results Summary:</strong><br>
          ð Total Logs: ${data.stats.total_logs.toLocaleString()}<br>
          ð¨ Anomalies Found: ${data.anomalies_count.toLocaleString()}<br>
          â ï¸ Alerts Generated: ${data.alerts_count}<br>
          â±ï¸ Processing Time: ${data.stats.processing_time}s<br>
          ð§ Method: ${data.method}<br>
          <br>
          <button class="btn btn-success" onclick="viewAnalysisResults('${
            data.file_id
          }')" style="margin-top: 10px;">
            <i class="fas fa-chart-bar"></i> View Full Results
          </button>
        `;

        // Reload recent analyses list
        loadRecentAnalyses();

        // Show success notification
        showNotification(
          "Analysis Complete",
          `Found ${data.anomalies_count} anomalies in ${data.stats.total_logs} logs`,
          "success"
        );
      });

      socket.on("dataset_analysis_failed", (data) => {
        console.error("â Dataset analysis failed:", data);
        document.getElementById("analysisStatus").textContent =
          "Analysis Failed!";
        document.getElementById("analysisDetails").innerHTML = `
          <strong style="color: #dc2626;">Error:</strong> ${data.error}<br>
          <button class="btn btn-primary" onclick="document.getElementById('analysisProgress').style.display='none'" style="margin-top: 10px;">
            Close
          </button>
        `;
      });

      // ==========================================
      // DATA UPDATE FUNCTIONS
      // ==========================================

      function updateStatistics(data) {
        document.getElementById("totalLogs").textContent = (
          data.total_logs || 0
        ).toLocaleString();
        document.getElementById("totalAnomalies").textContent = (
          data.total_anomalies || 0
        ).toLocaleString();
        document.getElementById("anomalyRate").textContent =
          ((data.anomaly_rate || 0) * 100).toFixed(2) + "%";
      }

      function addAnomalyToTable(anomaly) {
        const tbody = document.getElementById("anomalyTableBody");

        // Remove placeholder
        if (
          tbody.children.length === 1 &&
          tbody.children[0].children.length === 1
        ) {
          tbody.innerHTML = "";
        }

        const row = tbody.insertRow(0);
        const score = anomaly.anomaly_score || 0;
        const scoreClass =
          score > 0.8
            ? "anomaly-high"
            : score > 0.5
            ? "anomaly-medium"
            : "anomaly-low";

        row.innerHTML = `
          <td>${anomaly.timestamp || "N/A"}</td>
          <td>${anomaly.service || "N/A"}</td>
          <td>${anomaly.level || "N/A"}</td>
          <td>${anomaly.message || "N/A"}</td>
          <td>${anomaly.ip_address || "N/A"}</td>
          <td class="${scoreClass}">${score.toFixed(3)}</td>
        `;

        // Keep only last 50 rows
        while (tbody.rows.length > 50) {
          tbody.deleteRow(tbody.rows.length - 1);
        }
      }

      // ==========================================
      // CHART UPDATE FUNCTIONS
      // ==========================================

      function updateTimelineChart() {
        fetch("/api/timeline_data")
          .then((response) => response.json())
          .then((data) => {
            if (!data.timestamps || data.timestamps.length === 0) {
              document.getElementById("timelineChart").innerHTML =
                '<p style="text-align: center; color: #999; padding: 40px;">No timeline data available yet. Start the system to see anomalies over time.</p>';
              return;
            }

            const trace = {
              x: data.timestamps,
              y: data.counts,
              type: "scatter",
              mode: "lines+markers",
              fill: "tozeroy",
              fillcolor: "rgba(220, 38, 38, 0.2)",
              marker: { color: "#dc2626", size: 8 },
              line: { color: "#dc2626", width: 3 },
              name: "Anomalies",
            };

            const layout = {
              xaxis: { title: "Time" },
              yaxis: { title: "Number of Anomalies" },
              margin: { t: 20, r: 30, b: 80, l: 60 },
              paper_bgcolor: "white",
              plot_bgcolor: "white",
            };

            Plotly.newPlot("timelineChart", [trace], layout, {
              responsive: true,
            });
          })
          .catch((error) => {
            console.error("Error loading timeline:", error);
          });
      }

      function updateScoreChart() {
        if (anomalyScores.length === 0) {
          document.getElementById("scoreChart").innerHTML =
            '<p style="text-align: center; color: #999; padding: 40px;">No anomaly scores available yet.</p>';
          return;
        }

        const trace = {
          x: anomalyScores,
          type: "histogram",
          marker: { color: "#0f766e" },
          nbinsx: 20,
        };

        const layout = {
          xaxis: { title: "Anomaly Score (0-1)", range: [0, 1] },
          yaxis: { title: "Frequency" },
          margin: { t: 50, r: 30, b: 60, l: 60 },
        };

        Plotly.newPlot("scoreChart", [trace], layout, { responsive: true });
      }

      function updateServicePieChart() {
        fetch("/api/anomaly_distribution")
          .then((response) => response.json())
          .then((data) => {
            if (!data.services || data.services.length === 0) {
              document.getElementById("servicePieChart").innerHTML =
                '<p style="text-align: center; color: #999; padding: 40px;">No service data available yet.</p>';
              return;
            }

            const trace = {
              labels: data.services,
              values: data.counts,
              type: "pie",
              hole: 0.4,
            };

            const layout = {
              height: 400,
              margin: { t: 50, b: 30, l: 30, r: 30 },
            };

            Plotly.newPlot("servicePieChart", [trace], layout, {
              responsive: true,
            });
          })
          .catch((error) => console.error("Error loading pie chart:", error));
      }

      // ==========================================
      // NETWORK GRAPH FUNCTIONS
      // ==========================================

      function loadNetworkGraph() {
        console.log("Loading network graph...");

        fetch("/api/graph_data")
          .then((response) => response.json())
          .then((data) => {
            if (!data.nodes || data.nodes.length === 0) {
              document.getElementById("networkGraph").innerHTML =
                '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-size: 1.2em;">' +
                '<div style="text-align: center;"><i class="fas fa-project-diagram" style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;"></i>' +
                "<p>No network data available yet.</p></div></div>";
              document.getElementById("graphServiceCount").textContent = "0";
              document.getElementById("graphIpCount").textContent = "0";
              document.getElementById("graphUserCount").textContent = "0";
              document.getElementById("graphConnectionCount").textContent = "0";
              return;
            }

            networkGraphData = data;
            renderNetworkGraph(data);
          })
          .catch((error) => {
            console.error("Error loading network graph:", error);
          });
      }

      function renderNetworkGraph(data) {
        document.getElementById("networkGraph").innerHTML = "";

        const container = document.getElementById("networkGraph");
        const width = container.clientWidth;
        const height = 600;

        // â­ VALIDATE AND FILTER LINKS - Remove links that reference non-existent nodes
        const nodeIds = new Set(data.nodes.map((n) => n.id));
        const validLinks = data.links.filter((link) => {
          const sourceExists = nodeIds.has(link.source.id || link.source);
          const targetExists = nodeIds.has(link.target.id || link.target);

          if (!sourceExists || !targetExists) {
            console.warn(
              `Skipping invalid link: ${link.source.id || link.source} -> ${
                link.target.id || link.target
              }`
            );
            return false;
          }
          return true;
        });

        console.log(
          `Valid nodes: ${data.nodes.length}, Valid links: ${
            validLinks.length
          } (filtered ${data.links.length - validLinks.length} invalid)`
        );

        // Use validLinks instead of data.links
        data.links = validLinks;

        const svg = d3
          .select("#networkGraph")
          .append("svg")
          .attr("width", width)
          .attr("height", height);
        const zoom = d3
          .zoom()
          .scaleExtent([0.1, 4])
          .on("zoom", (event) => {
            g.attr("transform", event.transform);
          });

        svg.call(zoom);
        networkGraphZoom = zoom;

        const g = svg.append("g");

        // Update stats
        const serviceCount = data.nodes.filter(
          (n) => n.type === "service"
        ).length;
        const ipCount = data.nodes.filter((n) => n.type === "ip").length;
        const userCount = data.nodes.filter((n) => n.type === "user").length;

        document.getElementById("graphServiceCount").textContent = serviceCount;
        document.getElementById("graphIpCount").textContent = ipCount;
        document.getElementById("graphUserCount").textContent = userCount;
        document.getElementById("graphConnectionCount").textContent =
          data.links.length;

        // Create force simulation
        const simulation = d3
          .forceSimulation(data.nodes)
          .force(
            "link",
            d3
              .forceLink(data.links)
              .id((d) => d.id)
              .distance(100)
          )
          .force("charge", d3.forceManyBody().strength(-300))
          .force("center", d3.forceCenter(width / 2, height / 2));

        networkGraphSimulation = simulation;

        // Create links
        const link = g
          .append("g")
          .selectAll("line")
          .data(data.links)
          .enter()
          .append("line")
          .attr("class", (d) => (d.anomaly ? "link link-anomaly" : "link"));

        // Create nodes
        const node = g
          .append("g")
          .selectAll("circle")
          .data(data.nodes)
          .enter()
          .append("circle")
          .attr("class", (d) => `node node-${d.type}`)
          .attr("r", (d) => d.size || 15)
          .call(
            d3
              .drag()
              .on("start", (event, d) => {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
              })
              .on("drag", (event, d) => {
                d.fx = event.x;
                d.fy = event.y;
              })
              .on("end", (event, d) => {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
              })
          );

        // Create labels
        const label = g
          .append("g")
          .selectAll("text")
          .data(data.nodes)
          .enter()
          .append("text")
          .attr("class", "node-label")
          .text((d) => d.label || d.id);

        simulation.on("tick", () => {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);
          node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
          label.attr("x", (d) => d.x).attr("y", (d) => d.y + 4);
        });
      }

      function resetGraphZoom() {
        if (networkGraphSvg && networkGraphZoom) {
          networkGraphSvg
            .transition()
            .duration(750)
            .call(networkGraphZoom.transform, d3.zoomIdentity);
        }
      }

      function pauseGraphSimulation() {
        if (networkGraphSimulation) networkGraphSimulation.stop();
      }

      function resumeGraphSimulation() {
        if (networkGraphSimulation) networkGraphSimulation.restart();
      }

      function zoomGraphIn() {
        if (networkGraphSvg && networkGraphZoom) {
          networkGraphSvg
            .transition()
            .duration(300)
            .call(networkGraphZoom.scaleBy, 1.3);
        }
      }

      function zoomGraphOut() {
        if (networkGraphSvg && networkGraphZoom) {
          networkGraphSvg
            .transition()
            .duration(300)
            .call(networkGraphZoom.scaleBy, 0.7);
        }
      }

      // ==========================================
      // TAB SWITCHING
      // ==========================================

      function switchMainTab(tab) {
        document
          .querySelectorAll(".main-tab-content")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".aside-navbar .nav-item")
          .forEach((el) => el.classList.remove("active"));

        if (tab === "dashboard") {
          document.getElementById("dashboardTab").classList.add("active");
          document
            .querySelector('.aside-navbar .nav-item[data-tab="dashboard"]')
            .classList.add("active");
        } else if (tab === "dataset") {
          document.getElementById("datasetTab").classList.add("active");
          document
            .querySelector('.aside-navbar .nav-item[data-tab="dataset"]')
            .classList.add("active");
        } else if (tab === "network") {
          document.getElementById("networkTab").classList.add("active");
          document
            .querySelector('.aside-navbar .nav-item[data-tab="network"]')
            .classList.add("active");
          loadNetworkGraph();
        }
      }

      // ==========================================
      // NOTIFICATION FUNCTIONS
      // ==========================================

      function addNotification(anomaly) {
        const content = document.getElementById("notificationContent");
        const empty = content.querySelector(".notification-empty");
        if (empty) empty.remove();

        const item = document.createElement("div");
        item.className = "notification-item";
        item.innerHTML = `
          <div class="notification-item-icon"><i class="fas fa-exclamation-circle"></i></div>
          <div class="notification-item-content">
            <div class="notification-item-title">${
              anomaly.service || "Unknown Service"
            }</div>
            <div class="notification-item-message">${
              anomaly.message || "No message"
            }</div>
            <div class="notification-item-details">
              <span>Score: ${(anomaly.anomaly_score || 0).toFixed(3)}</span>
              <span>IP: ${anomaly.ip_address || "N/A"}</span>
            </div>
          </div>
          <button class="notification-item-close">Ã</button>
        `;

        item
          .querySelector(".notification-item-close")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            item.remove();
            updateBadge();
            if (content.querySelectorAll(".notification-item").length === 0) {
              content.innerHTML =
                '<div class="notification-empty"><i class="fas fa-inbox"></i><p>No alerts yet</p></div>';
            }
          });

        content.prepend(item);
        updateBadge();
      }

      function updateBadge() {
        const badge = document.getElementById("notificationBadge");
        const content = document.getElementById("notificationContent");
        const count = content.querySelectorAll(".notification-item").length;
        badge.textContent = count;
      }

      function toggleNotificationPanel() {
        const panel = document.getElementById("notificationPanel");
        panel.classList.toggle("active");
      }

      function clearAllNotifications() {
        const content = document.getElementById("notificationContent");
        content.innerHTML =
          '<div class="notification-empty"><i class="fas fa-inbox"></i><p>No alerts yet</p></div>';
        updateBadge();
      }

      // ==========================================
      // MODAL FUNCTIONS
      // ==========================================

      function openLogsModal() {
        document.getElementById("logsModal").style.display = "block";
        refreshLogs();
      }

      function closeLogsModal() {
        document.getElementById("logsModal").style.display = "none";
      }

      function refreshLogs() {
        fetch("/api/logs")
          .then((response) => response.json())
          .then((logs) => {
            const logsContent = document.getElementById("logsContent");
            const logsEmpty = document.getElementById("logsEmpty");
            const logsTableBody = document.getElementById("logsTableBody");

            if (logs.length === 0) {
              logsContent.style.display = "none";
              logsEmpty.style.display = "block";
              return;
            }

            logsContent.style.display = "block";
            logsEmpty.style.display = "none";

            logsTableBody.innerHTML = logs
              .map(
                (log) => `
                <tr>
                  <td style="padding: 10px; border: 1px solid #ddd;">${log.filename}</td>
                  <td style="padding: 10px; border: 1px solid #ddd;">${log.size}</td>
                  <td style="padding: 10px; border: 1px solid #ddd;">${log.created}</td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <a href="${log.download_url}" target="_blank" style="margin-right: 10px; color: #0f766e;">
                      <i class="fas fa-download"></i> Download
                    </a>
                  </td>
                </tr>
              `
              )
              .join("");
          })
          .catch((error) => console.error("Error fetching logs:", error));
      }

      // ==========================================
      // DATASET ANALYSIS FUNCTIONS
      // ==========================================

      function startDatasetAnalysis() {
        const fileInput = document.getElementById("datasetFile");
        const file = fileInput.files[0];

        if (!file) {
          alert("Please select a dataset file first");
          return;
        }

        const options = {
          use_spark_mllib: document.getElementById("useSparkMLlib").checked,
          generate_alerts: document.getElementById("generateAlerts").checked,
          anomaly_threshold: parseFloat(
            document.getElementById("anomalyThreshold").value
          ),
        };

        document.getElementById("analysisProgress").style.display = "block";
        document.getElementById("analysisProgressBar").style.width = "0%";
        document.getElementById("analysisStatus").textContent =
          "Uploading file...";

        const formData = new FormData();
        formData.append("file", file);

        fetch("/api/upload", { method: "POST", body: formData })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              document.getElementById("analysisProgressBar").style.width =
                "10%";
              document.getElementById("analysisStatus").textContent =
                "File uploaded, starting analysis...";

              return fetch("/api/uploaded/analyze", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  filepath: data.filepath,
                  options: options,
                }),
              });
            } else {
              throw new Error(data.error || "Upload failed");
            }
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              document.getElementById(
                "analysisDetails"
              ).innerHTML = `Analysis started!<br>File ID: ${data.file_id}`;
              document.getElementById("analysisProgressBar").style.width =
                "100%";
            } else {
              throw new Error(data.error || "Analysis failed");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            document.getElementById("analysisStatus").textContent =
              "Error: " + error.message;
          });
      }

      function loadRecentAnalyses() {
        console.log("Loading recent analyses...");

        fetch("/api/uploaded/list")
          .then((response) => response.json())
          .then((data) => {
            const listContainer = document.getElementById("recentAnalysesList");

            if (!data.analyses || data.analyses.length === 0) {
              listContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999;">
                  <i class="fas fa-database" style="font-size: 2.5em; margin-bottom: 15px; opacity: 0.5;"></i>
                  <p>No analyses found. Upload a dataset to get started.</p>
                </div>
              `;
              return;
            }

            listContainer.innerHTML = data.analyses
              .map((analysis) => {
                const anomalyRate =
                  analysis.total_logs > 0
                    ? (
                        (analysis.anomalies_found / analysis.total_logs) *
                        100
                      ).toFixed(2)
                    : 0;

                return `
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;"
                     onclick="viewAnalysisResults('${analysis.file_id}')"
                     onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.borderColor='#0f766e';"
                     onmouseout="this.style.boxShadow='none'; this.style.borderColor='#ddd';">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: #0f766e; margin-bottom: 5px;">
                        <i class="fas fa-file-alt"></i> ${analysis.filename}
                      </div>
                      <div style="font-size: 0.85em; color: #666;">
                        Completed: ${new Date(
                          analysis.analysis_completed
                        ).toLocaleString()}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <span style="display: inline-block; padding: 4px 10px; background: ${
                        analysis.critical_alerts > 0 ? "#fee2e2" : "#d1fae5"
                      }; color: ${
                  analysis.critical_alerts > 0 ? "#dc2626" : "#065f46"
                }; border-radius: 4px; font-size: 0.85em; font-weight: 600;">
                        ${analysis.status}
                      </span>
                    </div>
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                    <div style="text-align: center;">
                      <div style="font-size: 0.75em; color: #666; margin-bottom: 3px;">Total Logs</div>
                      <div style="font-weight: 600; color: #333;">${analysis.total_logs.toLocaleString()}</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 0.75em; color: #666; margin-bottom: 3px;">Anomalies</div>
                      <div style="font-weight: 600; color: #f59e0b;">${analysis.anomalies_found.toLocaleString()}</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 0.75em; color: #666; margin-bottom: 3px;">Critical</div>
                      <div style="font-weight: 600; color: #dc2626;">${
                        analysis.critical_alerts
                      }</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 0.75em; color: #666; margin-bottom: 3px;">Anomaly Rate</div>
                      <div style="font-weight: 600; color: #0f766e;">${anomalyRate}%</div>
                    </div>
                  </div>
                </div>
              `;
              })
              .join("");
          })
          .catch((error) => {
            console.error("Error loading analyses:", error);
            document.getElementById("recentAnalysesList").innerHTML = `
              <div style="text-align: center; padding: 40px; color: #dc2626;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2.5em; margin-bottom: 15px;"></i>
                <p>Error loading analyses: ${error.message}</p>
              </div>
            `;
          });
      }

      function viewAnalysisResults(fileId) {
        console.log("Viewing analysis results for:", fileId);

        // Fetch analysis results
        Promise.all([
          fetch(`/api/uploaded/results/${fileId}`).then((r) => r.json()),
          fetch(`/api/uploaded/statistics/${fileId}`).then((r) => r.json()),
          fetch(`/api/uploaded/distribution/${fileId}`).then((r) => r.json()),
        ])
          .then(([resultsData, statsData, distData]) => {
            const results = resultsData.results;
            const stats = statsData.statistics;
            const dist = distData;

            // Build results display
            const resultsHTML = `
            <div style="padding: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #0f766e; margin: 0;">
                  <i class="fas fa-chart-bar"></i> Analysis Results: ${
                    results.filename
                  }
                </h3>
                <button class="btn btn-secondary" onclick="document.getElementById('uploadTab').classList.add('active'); document.getElementById('resultsTab').classList.remove('active');">
                  <i class="fas fa-arrow-left"></i> Back
                </button>
              </div>
              
              <!-- Statistics Grid -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0f766e;">
                  <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Total Logs Analyzed</div>
                  <div style="font-size: 2em; font-weight: bold; color: #0f766e;">${stats.total_logs.toLocaleString()}</div>
                </div>
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                  <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Anomalies Found</div>
                  <div style="font-size: 2em; font-weight: bold; color: #f59e0b;">${stats.anomalies_found.toLocaleString()}</div>
                </div>
                <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                  <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Critical Alerts</div>
                  <div style="font-size: 2em; font-weight: bold; color: #dc2626;">${
                    stats.critical_alerts
                  }</div>
                </div>
                <div style="background: #dbeafe; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                  <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Processing Time</div>
                  <div style="font-size: 2em; font-weight: bold; color: #3b82f6;">${
                    stats.processing_time
                  }s</div>
                </div>
              </div>
              
              <!-- Charts -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                  <h4 style="color: #0f766e; margin-bottom: 10px;"><i class="fas fa-chart-pie"></i> Service Distribution</h4>
                  <div id="serviceDistChart_${fileId}"></div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                  <h4 style="color: #0f766e; margin-bottom: 10px;"><i class="fas fa-chart-bar"></i> Severity Distribution</h4>
                  <div id="severityDistChart_${fileId}"></div>
                </div>
              </div>
              
              <!-- Action Buttons -->
              <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="viewAnomalies('${fileId}')">
                  <i class="fas fa-exclamation-triangle"></i> View Anomalies (${
                    stats.anomalies_found
                  })
                </button>
                <button class="btn btn-primary" onclick="viewAlerts('${fileId}')">
                  <i class="fas fa-bell"></i> View Alerts (${
                    stats.critical_alerts +
                    stats.high_risk_alerts +
                    stats.medium_risk_alerts
                  })
                </button>
                <button class="btn btn-secondary" onclick="downloadResults('${fileId}')">
                  <i class="fas fa-download"></i> Download Report
                </button>
              </div>
              
              <!-- Details -->
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                <h4 style="color: #0f766e; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Analysis Details</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                  <div><strong>Analysis Method:</strong> ${
                    stats.analysis_method || "Spark MLlib"
                  }</div>
                  <div><strong>Services Analyzed:</strong> ${
                    stats.services_analyzed ? stats.services_analyzed.length : 0
                  }</div>
                  <div><strong>Suspicious IPs:</strong> ${
                    stats.suspicious_ips_found
                      ? stats.suspicious_ips_found.length
                      : 0
                  }</div>
                  <div><strong>Anomaly Rate:</strong> ${
                    statsData.summary.anomaly_rate
                  }%</div>
                  <div><strong>Time Range:</strong> ${
                    stats.time_range.start || "N/A"
                  } to ${stats.time_range.end || "N/A"}</div>
                  <div><strong>Spark UI:</strong> <a href="${
                    results.spark_job_url
                  }" target="_blank" style="color: #0f766e;">View Jobs</a></div>
                </div>
              </div>
            </div>
          `;

            // Show results
            document.getElementById("analysisResultsContent").innerHTML =
              resultsHTML;
            document.getElementById("uploadTab").classList.remove("active");
            document.getElementById("resultsTab").classList.add("active");

            // Render charts
            setTimeout(() => {
              renderServiceDistChart(fileId, dist.service_distribution);
              renderSeverityDistChart(fileId, dist.severity_distribution);
            }, 100);
          })
          .catch((error) => {
            console.error("Error viewing results:", error);
            alert("Error loading analysis results: " + error.message);
          });
      }

      function renderServiceDistChart(fileId, data) {
        const trace = {
          labels: Object.keys(data),
          values: Object.values(data),
          type: "pie",
          hole: 0.4,
        };

        const layout = {
          height: 300,
          margin: { t: 10, b: 10, l: 10, r: 10 },
          showlegend: true,
          legend: { orientation: "v", x: 1, y: 0.5 },
        };

        Plotly.newPlot(`serviceDistChart_${fileId}`, [trace], layout, {
          responsive: true,
        });
      }

      function renderSeverityDistChart(fileId, data) {
        const trace = {
          x: Object.keys(data),
          y: Object.values(data),
          type: "bar",
          marker: {
            color: ["#dc2626", "#f59e0b", "#fbbf24", "#10b981"],
          },
        };

        const layout = {
          height: 300,
          margin: { t: 10, b: 40, l: 40, r: 10 },
          xaxis: { title: "Severity Level" },
          yaxis: { title: "Count" },
        };

        Plotly.newPlot(`severityDistChart_${fileId}`, [trace], layout, {
          responsive: true,
        });
      }

      function viewAnomalies(fileId) {
        console.log("Viewing anomalies for:", fileId);

        // Fetch anomalies
        fetch(`/api/uploaded/anomalies/${fileId}?page=1&per_page=50`)
          .then((response) => response.json())
          .then((data) => {
            if (!data.anomalies || data.anomalies.length === 0) {
              alert("No anomalies found for this analysis.");
              return;
            }

            // Create modal HTML
            const modalHTML = `
              <div id="anomaliesModal" class="modal" style="display: block;">
                <div class="modal-content" style="max-width: 1200px; max-height: 80vh; overflow: auto;">
                  <span class="close-btn" onclick="document.getElementById('anomaliesModal').remove()">&times;</span>
                  <div class="modal-header">
                    <i class="fas fa-exclamation-triangle"></i> Anomalies (${data.pagination.total} found)
                  </div>
                  <div class="modal-body">
                    <!-- Filters -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                      <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em;">Filter by Service</label>
                        <select id="anomalyServiceFilter" onchange="filterAnomalies('${fileId}')" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                          <option value="">All Services</option>
                        </select>
                      </div>
                      <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em;">Min Severity Score</label>
                        <input type="number" id="anomalySeverityFilter" min="0" max="1" step="0.1" value="0" onchange="filterAnomalies('${fileId}')" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                      </div>
                      <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em;">Sort By</label>
                        <select id="anomalySortBy" onchange="filterAnomalies('${fileId}')" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                          <option value="score_desc">Score (High to Low)</option>
                          <option value="score_asc">Score (Low to High)</option>
                          <option value="time_desc">Time (Recent First)</option>
                          <option value="time_asc">Time (Oldest First)</option>
                        </select>
                      </div>
                    </div>
                    
                    <!-- Anomalies Table -->
                    <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                      <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead style="position: sticky; top: 0; background: #0f766e; color: white; z-index: 10;">
                          <tr>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Line</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Timestamp</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Service</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Level</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Message</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">IP Address</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Score</th>
                          </tr>
                        </thead>
                        <tbody id="anomaliesTableBody"></tbody>
                      </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="anomaliesPagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                      <div style="font-size: 0.9em; color: #666;">
                        Showing <strong id="anomalyShowingStart">1</strong> to <strong id="anomalyShowingEnd">50</strong> of <strong>${data.pagination.total}</strong> anomalies
                      </div>
                      <div style="display: flex; gap: 5px;" id="anomalyPaginationButtons"></div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="document.getElementById('anomaliesModal').remove()">Close</button>
                    <button class="btn btn-primary" onclick="exportAnomalies('${fileId}')">
                      <i class="fas fa-file-export"></i> Export to CSV
                    </button>
                  </div>
                </div>
              </div>
            `;

            // Add modal to DOM
            document.body.insertAdjacentHTML("beforeend", modalHTML);

            // Populate service filter
            const services = [...new Set(data.anomalies.map((a) => a.service))];
            const serviceFilter = document.getElementById(
              "anomalyServiceFilter"
            );
            services.forEach((service) => {
              serviceFilter.innerHTML += `<option value="${service}">${service}</option>`;
            });

            // Render anomalies
            renderAnomaliesTable(data.anomalies);
            renderAnomalyPagination(fileId, data.pagination);
          })
          .catch((error) => {
            console.error("Error loading anomalies:", error);
            alert("Error loading anomalies: " + error.message);
          });
      }

      function renderAnomaliesTable(anomalies) {
        const tbody = document.getElementById("anomaliesTableBody");
        tbody.innerHTML = anomalies
          .map((anomaly) => {
            const score = anomaly.anomaly_score || 0;
            const scoreColor =
              score >= 0.9
                ? "#dc2626"
                : score >= 0.7
                ? "#f59e0b"
                : score >= 0.5
                ? "#fbbf24"
                : "#10b981";
            const scoreBg =
              score >= 0.9
                ? "#fee2e2"
                : score >= 0.7
                ? "#fef3c7"
                : score >= 0.5
                ? "#fef9c3"
                : "#d1fae5";

            return `
            <tr style="border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <td style="padding: 10px; border: 1px solid #eee; font-weight: 600; color: #666;">${
                anomaly.line_number || "N/A"
              }</td>
              <td style="padding: 10px; border: 1px solid #eee; font-size: 0.85em;">${
                anomaly.timestamp || "N/A"
              }</td>
              <td style="padding: 10px; border: 1px solid #eee;">
                <span style="background: #e0f2fe; color: #0369a1; padding: 3px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 600;">${
                  anomaly.service || "unknown"
                }</span>
              </td>
              <td style="padding: 10px; border: 1px solid #eee;">
                <span style="background: ${
                  anomaly.level === "ERROR"
                    ? "#fee2e2"
                    : anomaly.level === "WARN"
                    ? "#fef3c7"
                    : "#f0fdf4"
                }; 
                             color: ${
                               anomaly.level === "ERROR"
                                 ? "#dc2626"
                                 : anomaly.level === "WARN"
                                 ? "#f59e0b"
                                 : "#10b981"
                             }; 
                             padding: 3px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 600;">${
                               anomaly.level || "INFO"
                             }</span>
              </td>
              <td style="padding: 10px; border: 1px solid #eee; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${
                anomaly.message || ""
              }">${anomaly.message || "N/A"}</td>
              <td style="padding: 10px; border: 1px solid #eee; font-family: monospace; font-size: 0.85em;">${
                anomaly.ip_address || "N/A"
              }</td>
              <td style="padding: 10px; border: 1px solid #eee; text-align: center;">
                <span style="background: ${scoreBg}; color: ${scoreColor}; padding: 5px 10px; border-radius: 4px; font-weight: 700; font-size: 0.9em;">${score.toFixed(
              3
            )}</span>
              </td>
            </tr>
          `;
          })
          .join("");
      }

      function renderAnomalyPagination(fileId, pagination) {
        const buttons = document.getElementById("anomalyPaginationButtons");
        const { page, pages, total, per_page } = pagination;

        buttons.innerHTML = "";

        // Previous button
        if (page > 1) {
          buttons.innerHTML += `<button class="btn btn-secondary" style="padding: 6px 12px;" onclick="loadAnomalyPage('${fileId}', ${
            page - 1
          })">
            <i class="fas fa-chevron-left"></i> Prev
          </button>`;
        }

        // Page numbers
        const startPage = Math.max(1, page - 2);
        const endPage = Math.min(pages, page + 2);

        for (let i = startPage; i <= endPage; i++) {
          const isActive = i === page;
          buttons.innerHTML += `<button class="btn ${
            isActive ? "btn-primary" : "btn-secondary"
          }" 
                                        style="padding: 6px 12px; ${
                                          isActive ? "font-weight: 700;" : ""
                                        }" 
                                        onclick="loadAnomalyPage('${fileId}', ${i})">${i}</button>`;
        }

        // Next button
        if (page < pages) {
          buttons.innerHTML += `<button class="btn btn-secondary" style="padding: 6px 12px;" onclick="loadAnomalyPage('${fileId}', ${
            page + 1
          })">
            Next <i class="fas fa-chevron-right"></i>
          </button>`;
        }

        // Update showing range
        const start = (page - 1) * per_page + 1;
        const end = Math.min(page * per_page, total);
        document.getElementById("anomalyShowingStart").textContent = start;
        document.getElementById("anomalyShowingEnd").textContent = end;
      }

      function loadAnomalyPage(fileId, page) {
        const service = document.getElementById("anomalyServiceFilter").value;
        const severity = document.getElementById("anomalySeverityFilter").value;

        let url = `/api/uploaded/anomalies/${fileId}?page=${page}&per_page=50`;
        if (service) url += `&service=${encodeURIComponent(service)}`;
        if (severity) url += `&severity=${severity}`;

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            renderAnomaliesTable(data.anomalies);
            renderAnomalyPagination(fileId, data.pagination);
          })
          .catch((error) => console.error("Error loading page:", error));
      }

      function filterAnomalies(fileId) {
        loadAnomalyPage(fileId, 1);
      }

      function exportAnomalies(fileId) {
        window.open(
          `/api/uploaded/anomalies/${fileId}?format=csv&page=1&per_page=999999`,
          "_blank"
        );
        showNotification(
          "Export Started",
          "Anomalies are being exported to CSV...",
          "info"
        );
      }

      function viewAlerts(fileId) {
        console.log("Viewing alerts for:", fileId);
        alert("Alert viewer will be implemented. Check console for details.");
        // This would show alerts with filtering
      }

      function downloadResults(fileId) {
        console.log("Downloading comprehensive report for:", fileId);

        showNotification(
          "Generating Report",
          "Please wait while we compile your analysis report...",
          "info"
        );

        // Fetch all necessary data for report generation
        Promise.all([
          fetch(`/api/uploaded/results/${fileId}`).then((r) => r.json()),
          fetch(`/api/uploaded/statistics/${fileId}`).then((r) => r.json()),
          fetch(`/api/uploaded/anomalies/${fileId}?page=1&per_page=100`).then(
            (r) => r.json()
          ),
          fetch(`/api/uploaded/alerts/${fileId}?page=1&per_page=100`).then(
            (r) => r.json()
          ),
        ])
          .then(([resultsData, statsData, anomaliesData, alertsData]) => {
            const results = resultsData.results;
            const stats = statsData.statistics;
            const summary = statsData.summary;
            const anomalies = anomaliesData.anomalies || [];
            const alerts = alertsData.alerts || [];

            // Generate comprehensive report
            const report = generateComprehensiveReport(
              results,
              stats,
              summary,
              anomalies,
              alerts,
              anomaliesData.pagination,
              alertsData.pagination
            );

            // Create blob and download
            const blob = new Blob([report], {
              type: "text/plain;charset=utf-8",
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `anomaly_analysis_report_${fileId}_${
              new Date().toISOString().split("T")[0]
            }.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showNotification(
              "Report Downloaded",
              "Analysis report has been downloaded successfully!",
              "success"
            );
          })
          .catch((error) => {
            console.error("Error generating report:", error);
            showNotification(
              "Download Failed",
              "Error generating report: " + error.message,
              "error"
            );
          });
      }

      function generateComprehensiveReport(
        results,
        stats,
        summary,
        anomalies,
        alerts,
        anomalyPagination,
        alertPagination
      ) {
        const timestamp = new Date().toLocaleString();
        const totalAlerts = alertPagination?.total || alerts.length;
        const totalAnomalies = anomalyPagination?.total || anomalies.length;

        // Calculate risk level
        const criticalRate = parseFloat(summary.critical_rate) || 0;
        const riskLevel =
          criticalRate > 10 ? "HIGH" : criticalRate > 5 ? "MEDIUM" : "LOW";

        let report = `
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
â               LOG ANOMALY DETECTION - COMPREHENSIVE ANALYSIS REPORT           â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
REPORT INFORMATION
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

Report Generated:        ${timestamp}
Analysis File:           ${results.filename}
Analysis Completed:      ${new Date(
          results.analysis_completed
        ).toLocaleString()}
Analysis Method:         ${stats.analysis_method || "Apache Spark MLlib"}
File ID:                 ${results.file_id}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
EXECUTIVE SUMMARY
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

ð PROCESSING STATISTICS
   ââ Total Logs Analyzed:        ${stats.total_logs.toLocaleString()}
   ââ Processing Time:             ${stats.processing_time}s
   ââ Analysis Duration:           ${stats.analysis_duration || "N/A"}
   ââ Spark Job URL:               ${results.spark_job_url}

ð¨ ANOMALY DETECTION RESULTS
   ââ Total Anomalies Found:       ${totalAnomalies.toLocaleString()}
   ââ Anomaly Rate:                ${summary.anomaly_rate}%
   ââ High Severity Anomalies:     ${stats.high_severity_anomalies || 0}
   ââ Medium Severity Anomalies:   ${stats.medium_severity_anomalies || 0}

â ï¸  SECURITY ALERTS GENERATED
   ââ Total Alerts:                ${totalAlerts}
   ââ Critical Alerts:             ${stats.critical_alerts}
   ââ High Risk Alerts:            ${stats.high_risk_alerts || 0}
   ââ Medium Risk Alerts:          ${stats.medium_risk_alerts || 0}
   ââ Low Risk Alerts:             ${stats.low_risk_alerts || 0}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
RISK ASSESSMENT
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

Overall Risk Level:      ${riskLevel}
Anomaly Rate:            ${summary.anomaly_rate}%
Critical Alert Rate:     ${summary.critical_rate}%

${
  criticalRate > 10
    ? "â ï¸  WARNING: High number of critical alerts detected! Immediate action required."
    : ""
}
${
  parseFloat(summary.anomaly_rate) > 15
    ? "â ï¸  WARNING: High anomaly rate detected! System may be under attack or experiencing issues."
    : ""
}
${
  stats.suspicious_ips_found && stats.suspicious_ips_found.length > 10
    ? "â ï¸  WARNING: Large number of suspicious IPs detected!"
    : ""
}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
SERVICES ANALYZED
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

Total Services:          ${
          stats.services_analyzed ? stats.services_analyzed.length : 0
        }

${
  stats.services_analyzed && stats.services_analyzed.length > 0
    ? stats.services_analyzed
        .map((s, i) => `${String(i + 1).padStart(3, " ")}. ${s}`)
        .join("\n")
    : "No service data available"
}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
SUSPICIOUS IP ADDRESSES
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

Total Suspicious IPs:    ${
          stats.suspicious_ips_found ? stats.suspicious_ips_found.length : 0
        }

${
  stats.suspicious_ips_found && stats.suspicious_ips_found.length > 0
    ? stats.suspicious_ips_found
        .slice(0, 20)
        .map((ip, i) => `${String(i + 1).padStart(3, " ")}. ${ip}`)
        .join("\n")
    : "No suspicious IPs detected"
}

${
  stats.suspicious_ips_found && stats.suspicious_ips_found.length > 20
    ? `\n... and ${stats.suspicious_ips_found.length - 20} more suspicious IPs`
    : ""
}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
ERROR PATTERNS DETECTED
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

${
  stats.error_patterns && Object.keys(stats.error_patterns).length > 0
    ? Object.entries(stats.error_patterns)
        .slice(0, 15)
        .map(
          ([pattern, count], i) =>
            `${String(i + 1).padStart(3, " ")}. [${String(count).padStart(
              5,
              " "
            )} occurrences] ${pattern}`
        )
        .join("\n")
    : "No significant error patterns detected"
}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
TOP 30 CRITICAL ANOMALIES
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

${
  anomalies.length > 0
    ? anomalies
        .slice(0, 30)
        .map(
          (a, i) => `
${String(i + 1).padStart(3, " ")}. ANOMALY #${a.line_number || "N/A"}
     Severity Score:     ${(a.anomaly_score || 0).toFixed(4)}
     Timestamp:          ${a.timestamp || "N/A"}
     Service:            ${a.service || "unknown"}
     Level:              ${a.level || "INFO"}
     IP Address:         ${a.ip_address || "N/A"}
     User:               ${a.user || "N/A"}
     Message:            ${
       a.message ? a.message.substring(0, 200) : "No message"
     }${a.message && a.message.length > 200 ? "..." : ""}
     ${"-".repeat(77)}
  `
        )
        .join("\n")
    : "No anomalies found"
}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
TOP 30 SECURITY ALERTS
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

${
  alerts.length > 0
    ? alerts
        .slice(0, 30)
        .map(
          (a, i) => `
${String(i + 1).padStart(3, " ")}. ALERT: ${a.message}
     Severity:           ${a.severity}
     Priority:           ${a.priority}
     Anomaly Score:      ${(a.anomaly_score || 0).toFixed(4)}
     Timestamp:          ${a.timestamp || "N/A"}
     Service:            ${a.service || "unknown"}
     IP Address:         ${a.ip_address || "N/A"}
     Line Number:        ${a.line_number || "N/A"}
     ${"-".repeat(77)}
  `
        )
        .join("\n")
    : "No alerts generated"
}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
SERVICE DISTRIBUTION
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

${
  stats.service_distribution &&
  Object.keys(stats.service_distribution).length > 0
    ? Object.entries(stats.service_distribution)
        .sort((a, b) => b[1] - a[1])
        .map(
          ([service, count], i) =>
            `${String(i + 1).padStart(3, " ")}. ${service.padEnd(
              30,
              " "
            )} ${String(count).padStart(8, " ")} logs`
        )
        .join("\n")
    : "No service distribution data available"
}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
TIME RANGE ANALYSIS
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

Analysis Start:          ${stats.time_range?.start || "N/A"}
Analysis End:            ${stats.time_range?.end || "N/A"}
Time Span:               ${stats.time_range?.duration || "N/A"}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
RECOMMENDATIONS & ACTION ITEMS
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

${
  stats.critical_alerts > 0
    ? `ð´ CRITICAL: ${stats.critical_alerts} critical alerts require immediate attention!
     ââ Review all critical alerts and take corrective action\n`
    : ""
}

${
  criticalRate > 10
    ? `ð´ CRITICAL: High critical alert rate (${criticalRate}%)
     ââ Investigate potential security breach or system failure\n`
    : ""
}

${
  parseFloat(summary.anomaly_rate) > 15
    ? `â ï¸  HIGH: Anomaly rate is ${summary.anomaly_rate}% (threshold: 15%)
     ââ Review system logs and investigate unusual patterns\n`
    : ""
}

${
  stats.suspicious_ips_found && stats.suspicious_ips_found.length > 10
    ? `â ï¸  HIGH: ${stats.suspicious_ips_found.length} suspicious IPs detected
     ââ Review IP access patterns and consider blocking suspicious sources\n`
    : ""
}

${
  stats.error_patterns && Object.keys(stats.error_patterns).length > 5
    ? `â ï¸  MEDIUM: ${
        Object.keys(stats.error_patterns).length
      } distinct error patterns found
     ââ Review recurring errors and fix root causes\n`
    : ""
}

â STANDARD ACTIONS:
   ââ Continue monitoring system for unusual activity
   ââ Review all high and critical severity anomalies
   ââ Investigate top suspicious IP addresses
   ââ Address recurring error patterns
   ââ Update security policies based on findings
   ââ Schedule follow-up analysis in 24-48 hours

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
TECHNICAL DETAILS
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

Analysis Configuration:
   ââ Method:                      ${stats.analysis_method || "Spark MLlib"}
   ââ Threshold:                   ${stats.threshold || "Default"}
   ââ Features Used:               ${
     stats.features_used || "Standard feature set"
   }
   ââ Model Version:               ${stats.model_version || "v1.0"}
   ââ Spark UI:                    ${results.spark_job_url}

System Information:
   ââ Analysis Engine:             Apache Spark 3.x with MLlib
   ââ Detection Algorithm:         Isolation Forest + Pattern Matching
   ââ Feature Engineering:         TF-IDF, Statistical Analysis
   ââ Alert Generation:            Rule-based + ML Scoring

Performance Metrics:
   ââ Logs Processed per Second:  ${
     stats.total_logs && stats.processing_time
       ? Math.round(stats.total_logs / stats.processing_time)
       : "N/A"
   }
   ââ Total Processing Time:       ${stats.processing_time}s
   ââ Memory Usage:                ${stats.memory_usage || "N/A"}
   ââ CPU Utilization:             ${stats.cpu_usage || "N/A"}

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
SUMMARY STATISTICS
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

Total Logs:              ${stats.total_logs.toLocaleString()}
Total Anomalies:         ${totalAnomalies.toLocaleString()}
Total Alerts:            ${totalAlerts}
Anomaly Rate:            ${summary.anomaly_rate}%
Critical Rate:           ${summary.critical_rate}%
Services Analyzed:       ${
          stats.services_analyzed ? stats.services_analyzed.length : 0
        }
Suspicious IPs:          ${
          stats.suspicious_ips_found ? stats.suspicious_ips_found.length : 0
        }
Error Patterns:          ${
          stats.error_patterns ? Object.keys(stats.error_patterns).length : 0
        }
Processing Time:         ${stats.processing_time}s

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

Report Generation Complete

Generated by:            Log Anomaly Detection System v1.0
Powered by:              Apache Spark MLlib
Report Date:             ${timestamp}
Analysis File:           ${results.filename}
File ID:                 ${results.file_id}

Â© 2025 Anomaly Detection Platform | All Rights Reserved

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ

For questions or support, please contact your system administrator.
For detailed analysis and interactive visualizations, visit the web dashboard.

END OF REPORT

âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
`;

        return report;
      }

      function showNotification(title, message, type = "info") {
        const colors = {
          success: { bg: "#d1fae5", border: "#10b981", icon: "check-circle" },
          error: {
            bg: "#fee2e2",
            border: "#dc2626",
            icon: "exclamation-circle",
          },
          warning: {
            bg: "#fef3c7",
            border: "#f59e0b",
            icon: "exclamation-triangle",
          },
          info: { bg: "#dbeafe", border: "#3b82f6", icon: "info-circle" },
        };

        const style = colors[type] || colors.info;

        const notification = document.createElement("div");
        notification.style.cssText = `
          position: fixed;
          top: 90px;
          right: 20px;
          background: ${style.bg};
          border-left: 4px solid ${style.border};
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          max-width: 350px;
          z-index: 10000;
          animation: slideInRight 0.3s ease;
        `;

        notification.innerHTML = `
          <div style="display: flex; align-items: start; gap: 10px;">
            <i class="fas fa-${style.icon}" style="font-size: 1.5em; color: ${style.border};"></i>
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 5px; color: #333;">${title}</div>
              <div style="font-size: 0.9em; color: #666;">${message}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2em; color: #999; cursor: pointer; padding: 0; width: 20px; height: 20px;">Ã</button>
          </div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.transition = "opacity 0.3s ease";
          notification.style.opacity = "0";
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }

      // ==========================================
      // INITIALIZATION
      // ==========================================

      function fetchInitialData() {
        console.log("ð¥ Fetching initial data...");

        fetch("/api/stats")
          .then((response) => response.json())
          .then((data) => {
            console.log("Stats received:", data);
            updateStatistics(data);
            document.getElementById("criticalAlerts").textContent =
              data.critical_alerts || 0;
          })
          .catch((error) => console.error("Error fetching stats:", error));

        fetch("/api/recent_anomalies")
          .then((response) => response.json())
          .then((anomalies) => {
            console.log("Recent anomalies received:", anomalies.length);
            if (Array.isArray(anomalies)) {
              anomalies.forEach((anomaly) => {
                addAnomalyToTable(anomaly);
                anomalyScores.push(anomaly.anomaly_score || 0);
              });
              updateScoreChart();
            }
          })
          .catch((error) => console.error("Error fetching anomalies:", error));

        updateTimelineChart();
        updateServicePieChart();
        updateLastUpdated();
      }

      // Initialize dashboard
      console.log("ð Initializing dashboard...");
      fetchInitialData();

      // Refresh data periodically
      setInterval(fetchInitialData, 10000);
      setInterval(updateTimelineChart, 5000);
      setInterval(updateServicePieChart, 10000);

      // Threshold slider
      const thresholdSlider = document.getElementById("anomalyThreshold");
      const thresholdValue = document.getElementById("thresholdValue");
      if (thresholdSlider && thresholdValue) {
        thresholdSlider.addEventListener("input", function () {
          thresholdValue.textContent = this.value;
        });
      }

      console.log("Dashboard initialized successfully!");
    </script>
  </body>
</html>
