<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Log Anomaly Detection Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        padding: 20px;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-card h3 {
        color: #667eea;
        font-size: 0.9em;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #333;
      }

      .stat-card.critical {
        border-left: 5px solid #e74c3c;
      }

      .stat-card.warning {
        border-left: 5px solid #f39c12;
      }

      .stat-card.success {
        border-left: 5px solid #27ae60;
      }

      .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .chart-card h2 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      #anomalyTable {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: #667eea;
        color: white;
        padding: 12px;
        text-align: left;
        position: sticky;
        top: 0;
      }

      td {
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .anomaly-high {
        background: #fee;
        color: #c00;
        font-weight: bold;
      }

      .anomaly-medium {
        background: #ffd;
        color: #c60;
      }

      .anomaly-low {
        background: #efe;
        color: #060;
      }

      .alert {
        background: #e74c3c;
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        animation: blink 1s infinite;
      }

      .status-online {
        background: #27ae60;
      }

      @keyframes blink {
        0%,
        50%,
        100% {
          opacity: 1;
        }
        25%,
        75% {
          opacity: 0.3;
        }
      }

      #networkGraph {
        width: 100%;
        height: 500px;
        border: 1px solid #ddd;
        border-radius: 10px;
      }

      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 10px 20px;
        border-radius: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Real-time Log Anomaly Detection Dashboard</h1>

      <div class="connection-status">
        <span class="status-indicator status-online"></span>
        <span id="connectionStatus">Connected</span>
      </div>

      <div id="alertContainer"></div>

      <div class="stats-grid">
        <div class="stat-card success">
          <h3>Total Logs Processed</h3>
          <div class="stat-value" id="totalLogs">0</div>
        </div>
        <div class="stat-card warning">
          <h3>Anomalies Detected</h3>
          <div class="stat-value" id="totalAnomalies">0</div>
        </div>
        <div class="stat-card critical">
          <h3>Anomaly Rate</h3>
          <div class="stat-value" id="anomalyRate">0%</div>
        </div>
        <div class="stat-card critical">
          <h3>Critical Alerts</h3>
          <div class="stat-value" id="criticalAlerts">0</div>
        </div>
      </div>

      <div class="charts-container">
        <div class="chart-card">
          <h2>üìä Anomaly Timeline</h2>
          <div id="timelineChart"></div>
        </div>
        <div class="chart-card">
          <h2>üéØ Anomaly Score Distribution</h2>
          <div id="scoreChart"></div>
        </div>
      </div>

      <div class="chart-card" style="margin-bottom: 30px">
        <h2>üï∏Ô∏è Network Graph - Service Interactions</h2>
        <div id="networkGraph"></div>
      </div>

      <div id="anomalyTable">
        <h2 style="color: #667eea; margin-bottom: 15px">üö® Recent Anomalies</h2>
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Service</th>
              <th>Level</th>
              <th>Message</th>
              <th>IP Address</th>
              <th>Anomaly Score</th>
            </tr>
          </thead>
          <tbody id="anomalyTableBody">
            <tr>
              <td colspan="6" style="text-align: center; color: #999">
                Waiting for anomalies...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Initialize Socket.IO connection
      const socket = io();

      // Data storage
      let anomalyScores = [];
      let timelineData = { timestamps: [], counts: [] };

      // Socket event handlers
      socket.on("connect", () => {
        document.getElementById("connectionStatus").textContent = "Connected";
        console.log("Connected to server");
      });

      socket.on("disconnect", () => {
        document.getElementById("connectionStatus").textContent =
          "Disconnected";
        console.log("Disconnected from server");
      });

      socket.on("new_anomaly", (data) => {
        addAnomalyToTable(data);
        anomalyScores.push(data.anomaly_score || 0);
        updateScoreChart();

        if (data.anomaly_score > 0.8) {
          showAlert(data);
        }
      });

      socket.on("stats_update", (data) => {
        updateStatistics(data);
      });

      // Update statistics
      function updateStatistics(data) {
        document.getElementById("totalLogs").textContent =
          data.total_logs.toLocaleString();
        document.getElementById("totalAnomalies").textContent =
          data.total_anomalies.toLocaleString();
        document.getElementById("anomalyRate").textContent =
          (data.anomaly_rate * 100).toFixed(2) + "%";
      }

      // Add anomaly to table
      function addAnomalyToTable(anomaly) {
        const tbody = document.getElementById("anomalyTableBody");

        // Remove placeholder if exists
        if (
          tbody.children.length === 1 &&
          tbody.children[0].children.length === 1
        ) {
          tbody.innerHTML = "";
        }

        const row = tbody.insertRow(0);
        const score = anomaly.anomaly_score || 0;
        const scoreClass =
          score > 0.8
            ? "anomaly-high"
            : score > 0.5
            ? "anomaly-medium"
            : "anomaly-low";

        row.innerHTML = `
                <td>${anomaly.timestamp || "N/A"}</td>
                <td>${anomaly.service || "N/A"}</td>
                <td>${anomaly.level || "N/A"}</td>
                <td>${anomaly.message || "N/A"}</td>
                <td>${anomaly.ip_address || "N/A"}</td>
                <td class="${scoreClass}">${score.toFixed(3)}</td>
            `;

        // Keep only last 50 rows
        while (tbody.rows.length > 50) {
          tbody.deleteRow(tbody.rows.length - 1);
        }
      }

      // Show critical alert
      function showAlert(anomaly) {
        const alertContainer = document.getElementById("alertContainer");
        const alert = document.createElement("div");
        alert.className = "alert";
        alert.innerHTML = `
                <strong>‚ö†Ô∏è CRITICAL ANOMALY DETECTED!</strong><br>
                Service: ${
                  anomaly.service
                } | Score: ${anomaly.anomaly_score.toFixed(3)} | IP: ${
          anomaly.ip_address
        }
            `;
        alertContainer.appendChild(alert);

        setTimeout(() => {
          alert.remove();
        }, 10000);
      }

      // Update score distribution chart
      function updateScoreChart() {
        const trace = {
          x: anomalyScores,
          type: "histogram",
          marker: {
            color: "#667eea",
          },
          nbinsx: 20,
        };

        const layout = {
          title: "",
          xaxis: { title: "Anomaly Score" },
          yaxis: { title: "Count" },
          margin: { t: 20, r: 20, b: 40, l: 50 },
        };

        Plotly.newPlot("scoreChart", [trace], layout, { responsive: true });
      }

      // Update timeline chart
      function updateTimelineChart() {
        fetch("/api/timeline_data")
          .then((response) => response.json())
          .then((data) => {
            const trace = {
              x: data.timestamps,
              y: data.counts,
              type: "scatter",
              mode: "lines+markers",
              marker: { color: "#e74c3c" },
              line: { color: "#e74c3c", width: 2 },
            };

            const layout = {
              title: "",
              xaxis: { title: "Time" },
              yaxis: { title: "Anomalies" },
              margin: { t: 20, r: 20, b: 80, l: 50 },
            };

            Plotly.newPlot("timelineChart", [trace], layout, {
              responsive: true,
            });
          });
      }

      // Load network graph
      function loadNetworkGraph() {
        fetch("/api/graph_data")
          .then((response) => response.json())
          .then((data) => {
            if (data.nodes.length === 0) {
              document.getElementById("networkGraph").innerHTML =
                '<p style="text-align: center; padding: 50px; color: #999;">Graph data not available yet</p>';
              return;
            }

            const width = document.getElementById("networkGraph").clientWidth;
            const height = 500;

            const svg = d3
              .select("#networkGraph")
              .html("")
              .append("svg")
              .attr("width", width)
              .attr("height", height);

            const simulation = d3
              .forceSimulation(data.nodes)
              .force(
                "link",
                d3
                  .forceLink(data.links)
                  .id((d) => d.id)
                  .distance(100)
              )
              .force("charge", d3.forceManyBody().strength(-300))
              .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg
              .append("g")
              .selectAll("line")
              .data(data.links)
              .enter()
              .append("line")
              .attr("stroke", "#999")
              .attr("stroke-opacity", 0.6)
              .attr("stroke-width", (d) => Math.sqrt(d.value));

            const node = svg
              .append("g")
              .selectAll("circle")
              .data(data.nodes)
              .enter()
              .append("circle")
              .attr("r", 8)
              .attr("fill", (d) => {
                if (d.type === "service") return "#667eea";
                if (d.type === "ip") return "#e74c3c";
                return "#27ae60";
              })
              .call(
                d3
                  .drag()
                  .on("start", dragstarted)
                  .on("drag", dragged)
                  .on("end", dragended)
              );

            node.append("title").text((d) => d.id);

            simulation.on("tick", () => {
              link
                .attr("x1", (d) => d.source.x)
                .attr("y1", (d) => d.source.y)
                .attr("x2", (d) => d.target.x)
                .attr("y2", (d) => d.target.y);

              node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
            });

            function dragstarted(event) {
              if (!event.active) simulation.alphaTarget(0.3).restart();
              event.subject.fx = event.subject.x;
              event.subject.fy = event.subject.y;
            }

            function dragged(event) {
              event.subject.fx = event.x;
              event.subject.fy = event.y;
            }

            function dragended(event) {
              if (!event.active) simulation.alphaTarget(0);
              event.subject.fx = null;
              event.subject.fy = null;
            }
          });
      }

      // Fetch initial data
      function fetchInitialData() {
        fetch("/api/stats")
          .then((response) => response.json())
          .then((data) => {
            updateStatistics(data);
            document.getElementById("criticalAlerts").textContent =
              data.critical_alerts;
          });

        fetch("/api/recent_anomalies")
          .then((response) => response.json())
          .then((anomalies) => {
            anomalies.forEach((anomaly) => {
              addAnomalyToTable(anomaly);
              anomalyScores.push(anomaly.anomaly_score || 0);
            });
            updateScoreChart();
          });

        updateTimelineChart();
        loadNetworkGraph();
      }

      // Initialize dashboard
      fetchInitialData();

      // Refresh data periodically
      setInterval(fetchInitialData, 10000);
      setInterval(updateTimelineChart, 5000);
    </script>
  </body>
</html>
